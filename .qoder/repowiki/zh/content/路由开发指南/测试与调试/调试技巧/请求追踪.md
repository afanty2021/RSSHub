# 请求追踪

<cite>
**本文档引用的文件**
- [trace.ts](file://lib/middleware/trace.ts)
- [config.ts](file://lib/config.ts)
- [otel/trace.ts](file://lib/utils/otel/trace.ts)
- [otel/metric.ts](file://lib/utils/otel/metric.ts)
- [app-bootstrap.tsx](file://lib/app-bootstrap.tsx)
- [debug-info.ts](file://lib/utils/debug-info.ts)
- [logger.ts](file://lib/middleware/logger.ts)
- [metrics.ts](file://lib/routes/metrics.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
RSSHub 的请求追踪功能为系统诊断和性能分析提供了强大的工具。本技术文档详细说明了如何使用 RSSHub 的请求追踪功能来诊断问题，包括追踪 ID 的生成和传播机制、在分布式环境中跟踪单个请求的完整生命周期、追踪数据的收集和展示方式，以及如何利用追踪信息定位性能瓶颈、识别错误源头和分析系统依赖关系。

## 项目结构
RSSHub 的请求追踪功能主要分布在中间件和工具模块中，通过 OpenTelemetry 实现全面的监控和追踪能力。

```mermaid
graph TD
subgraph "中间件层"
Trace[trace.ts]
Debug[debug.ts]
Logger[logger.ts]
Sentry[sentry.ts]
end
subgraph "工具模块"
Otel[utils/otel]
Config[config.ts]
Helpers[helpers.ts]
end
subgraph "路由层"
Metrics[routes/metrics.ts]
end
Trace --> Otel
Debug --> Config
Logger --> Otel
Otel --> Metrics
```

**图示来源**
- [trace.ts](file://lib/middleware/trace.ts)
- [debug.ts](file://lib/middleware/debug.ts)
- [logger.ts](file://lib/middleware/logger.ts)
- [sentry.ts](file://lib/middleware/sentry.ts)
- [otel](file://lib/utils/otel)
- [config.ts](file://lib/config.ts)
- [metrics.ts](file://lib/routes/metrics.ts)

**章节来源**
- [app-bootstrap.tsx](file://lib/app-bootstrap.tsx)
- [middleware](file://lib/middleware)

## 核心组件
RSSHub 的请求追踪系统由多个核心组件构成，包括追踪中间件、OpenTelemetry 工具、配置管理、性能指标收集和调试信息管理。这些组件协同工作，提供了完整的请求追踪能力。

**章节来源**
- [trace.ts](file://lib/middleware/trace.ts)
- [otel/trace.ts](file://lib/utils/otel/trace.ts)
- [otel/metric.ts](file://lib/utils/otel/metric.ts)
- [config.ts](file://lib/config.ts)

## 架构概述
RSSHub 的请求追踪架构基于 OpenTelemetry 实现，采用分层设计，从请求进入系统到响应返回的整个生命周期都受到监控。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant TraceMiddleware as "追踪中间件"
participant Otel as "OpenTelemetry"
participant Metrics as "指标服务"
participant Logger as "日志系统"
Client->>TraceMiddleware : 发起请求
TraceMiddleware->>Otel : 创建追踪跨度
Otel-->>TraceMiddleware : 返回跨度对象
TraceMiddleware->>Logger : 记录请求开始
TraceMiddleware->>Client : 继续处理链
Client-->>TraceMiddleware : 处理完成
TraceMiddleware->>Otel : 结束追踪跨度
TraceMiddleware->>Logger : 记录响应完成
TraceMiddleware->>Metrics : 更新性能指标
TraceMiddleware-->>Client : 返回响应
```

**图示来源**
- [trace.ts](file://lib/middleware/trace.ts)
- [otel/trace.ts](file://lib/utils/otel/trace.ts)
- [otel/metric.ts](file://lib/utils/otel/metric.ts)
- [logger.ts](file://lib/middleware/logger.ts)

## 详细组件分析

### 追踪中间件分析
追踪中间件是 RSSHub 请求追踪系统的核心，负责在请求处理过程中创建和管理追踪跨度。

```mermaid
flowchart TD
Start([请求进入]) --> CheckDebug["检查调试模式"]
CheckDebug --> |启用| CreateSpan["创建追踪跨度"]
CheckDebug --> |禁用| Skip["跳过追踪"]
CreateSpan --> AddEvent["添加事件: invoking handleRequest"]
AddEvent --> ProcessRequest["处理请求"]
ProcessRequest --> EndSpan["结束追踪跨度"]
EndSpan --> ReturnResponse["返回响应"]
Skip --> ProcessRequest
ProcessRequest --> ReturnResponse
```

**图示来源**
- [trace.ts](file://lib/middleware/trace.ts)

**章节来源**
- [trace.ts](file://lib/middleware/trace.ts)
- [config.ts](file://lib/config.ts)

### OpenTelemetry 集成分析
OpenTelemetry 模块为 RSSHub 提供了标准化的追踪和指标收集能力。

```mermaid
classDiagram
class OTLPTraceExporter {
+export(spans)
+shutdown()
}
class BasicTracerProvider {
+getTracer(name)
+forceFlush()
+shutdown()
}
class BatchSpanProcessor {
+onStart(span)
+onEnd(span)
+forceFlush()
+shutdown()
}
class PrometheusExporter {
+startServer()
+stopServer()
+collect()
}
class MeterProvider {
+getMeter(name)
+forceFlush()
+shutdown()
}
OTLPTraceExporter --> BasicTracerProvider : "作为导出器"
BatchSpanProcessor --> BasicTracerProvider : "作为处理器"
PrometheusExporter --> MeterProvider : "作为读取器"
```

**图示来源**
- [otel/trace.ts](file://lib/utils/otel/trace.ts)
- [otel/metric.ts](file://lib/utils/otel/metric.ts)

**章节来源**
- [otel/trace.ts](file://lib/utils/otel/trace.ts)
- [otel/metric.ts](file://lib/utils/otel/metric.ts)

### 配置管理分析
配置系统控制着请求追踪功能的启用和行为，通过环境变量进行灵活配置。

```mermaid
erDiagram
CONFIG {
string DEBUG_INFO PK
string OTEL_SECONDS_BUCKET
string OTEL_MILLISECONDS_BUCKET
string SENTRY_DSN
number SENTRY_ROUTE_TIMEOUT
}
DEBUG_INFO ||--o{ TRACE : "控制"
OTEL_SECONDS_BUCKET ||--o{ METRIC : "影响"
OTEL_MILLISECONDS_BUCKET ||--o{ METRIC : "影响"
SENTRY_DSN ||--o{ SENTRY : "启用"
SENTRY_ROUTE_TIMEOUT ||--o{ SENTRY : "控制"
```

**图示来源**
- [config.ts](file://lib/config.ts)

**章节来源**
- [config.ts](file://lib/config.ts)

## 依赖分析
RSSHub 的请求追踪系统依赖于多个外部库和内部模块，形成了复杂的依赖关系网络。

```mermaid
graph TD
Hono --> TraceMiddleware
Hono --> DebugMiddleware
Hono --> LoggerMiddleware
Hono --> SentryMiddleware
TraceMiddleware --> OpenTelemetryAPI
TraceMiddleware --> OTLPTraceExporter
TraceMiddleware --> BasicTracerProvider
LoggerMiddleware --> OpenTelemetryMetric
LoggerMiddleware --> PrometheusExporter
DebugMiddleware --> DebugInfo
OpenTelemetryAPI --> OpenTelemetrySDK
OpenTelemetrySDK --> OTLPTraceExporter
OpenTelemetrySDK --> PrometheusExporter
DebugInfo --> Config
Config --> Environment
MetricsRoute --> PrometheusExporter
MetricsRoute --> Serializer
```

**图示来源**
- [package.json](file://package.json)
- [pnpm-lock.yaml](file://pnpm-lock.yaml)
- [app-bootstrap.tsx](file://lib/app-bootstrap.tsx)

**章节来源**
- [app-bootstrap.tsx](file://lib/app-bootstrap.tsx)
- [config.ts](file://lib/config.ts)
- [middleware](file://lib/middleware)

## 性能考虑
请求追踪功能对系统性能有一定影响，需要通过配置选项进行权衡和优化。

**章节来源**
- [config.ts](file://lib/config.ts)
- [trace.ts](file://lib/middleware/trace.ts)
- [otel/trace.ts](file://lib/utils/otel/trace.ts)

## 故障排除指南
当请求追踪功能出现问题时，可以通过以下步骤进行诊断和解决。

**章节来源**
- [trace.ts](file://lib/middleware/trace.ts)
- [otel/trace.ts](file://lib/utils/otel/trace.ts)
- [config.ts](file://lib/config.ts)

## 结论
RSSHub 的请求追踪系统通过 OpenTelemetry 实现了全面的监控能力，为系统诊断和性能优化提供了有力支持。通过合理的配置和使用，可以有效定位性能瓶颈、识别错误源头并分析系统依赖关系。