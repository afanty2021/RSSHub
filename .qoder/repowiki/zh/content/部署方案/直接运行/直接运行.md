# 直接运行

<cite>
**本文档中引用的文件**  
- [package.json](file://package.json)
- [tsconfig.json](file://tsconfig.json)
- [README.md](file://README.md)
- [lib/index.ts](file://lib/index.ts)
- [lib/config.ts](file://lib/config.ts)
- [lib/app-bootstrap.tsx](file://lib/app-bootstrap.tsx)
- [scripts/ansible/rsshub.env](file://scripts/ansible/rsshub.env)
- [scripts/ansible/rsshub.service](file://scripts/ansible/rsshub.service)
- [lib/utils/logger.ts](file://lib/utils/logger.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [Node.js环境要求](#nodejs环境要求)
4. [依赖管理与pnpm使用](#依赖管理与pnpm使用)
5. [tsconfig.json配置详解](#tsconfigjson配置详解)
6. [应用启动、停止与重启](#应用启动停止与重启)
7. [PM2进程管理集成](#pm2进程管理集成)
8. [系统服务配置](#系统服务配置)
9. [配置文件详解](#配置文件详解)

## 简介

RSSHub是一个全球最大的RSS网络，包含超过5000个全球实例。本文档详细介绍如何在没有容器环境的情况下直接部署和运行RSSHub，涵盖Node.js环境配置、依赖管理、应用启动和进程管理等关键方面。

**Section sources**
- [README.md](file://README.md#L1-L62)

## 项目结构

RSSHub项目采用模块化设计，主要结构如下：
- `lib/` - 核心源代码目录，包含API、中间件、路由和工具函数
- `assets/` - 静态资源文件
- `scripts/` - 部署和构建脚本
- 根目录包含配置文件如`package.json`、`tsconfig.json`等

核心应用逻辑位于`lib/`目录下，通过Hono框架构建，采用TypeScript开发。

**Section sources**
- [package.json](file://package.json#L1-L249)
- [README.md](file://README.md#L1-L62)

## Node.js环境要求

RSSHub对Node.js版本有明确要求，根据`package.json`中的engines字段：

```json
"engines": {
    "node": "^22.20.0 || ^24"
}
```

### 版本兼容性要求
- 支持Node.js 22.20.0及以上版本
- 支持Node.js 24及以上版本
- 推荐使用LTS（长期支持）版本以确保稳定性

### 安装方法

#### 使用Node Version Manager (nvm)
```bash
# 安装nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载shell配置
source ~/.bashrc

# 安装并使用Node.js 24
nvm install 24
nvm use 24
nvm alias default 24
```

#### 验证安装
```bash
node --version
npm --version
```

确保Node.js版本符合要求，否则可能导致应用无法正常运行。

**Section sources**
- [package.json](file://package.json#L208-L210)

## 依赖管理与pnpm使用

RSSHub使用pnpm作为包管理器，这在`package.json`中有明确指定：

```json
"packageManager": "pnpm@10.22.0+sha512.bf049efe995b28f527fd2b41ae0474ce29186f7edcb3bf545087bd61fbbebb2bf75362d1307fda09c2d288e1e499787ac12d4fcb617a974718a6051f2eee741c"
```

### pnpm安装

```bash
# 使用npm全局安装pnpm
npm install -g pnpm

# 或使用corepack（Node.js 16.13+内置）
corepack enable
corepack prepare pnpm@10.22.0 --activate
```

### 依赖安装最佳实践

#### 安装项目依赖
```bash
# 安装所有依赖
pnpm install

# 生产环境安装（仅生产依赖）
pnpm install --prod
```

#### pnpm优势
- **磁盘空间效率**：通过硬链接和符号链接避免重复包
- **安装速度快**：并行下载和安装
- **确定性安装**：`pnpm-lock.yaml`确保依赖一致性
- **严格模式**：防止未声明的依赖使用

#### pnpm配置
项目根目录的`.npmrc`文件包含pnpm特定配置，确保一致的安装行为。

**Section sources**
- [package.json](file://package.json#L207-L247)

## tsconfig.json配置详解

`tsconfig.json`文件定义了TypeScript编译器的配置选项，对RSSHub的构建和运行时行为有重要影响。

```json
{
    "compilerOptions": {
        "target": "ESNext",
        "module": "ESNext",
        "moduleResolution": "bundler",
        "strict": true,
        "jsx": "react-jsx",
        "jsxImportSource": "hono/jsx",
        "paths": {
            "@/*": ["./lib/*"]
        },
        "esModuleInterop": true,
        "noImplicitAny": false,
        "outDir": "./dist",
        "skipLibCheck": true,
        "noEmit": true,
        "incremental": true,
        "resolveJsonModule": true,
        "isolatedModules": true
    },
    "include": ["./lib/**/*"],
    "exclude": ["node_modules", "*.test.*"]
}
```

### 关键配置选项说明

#### 编译目标
- `target: "ESNext"` - 编译为最新ECMAScript标准
- `module: "ESNext"` - 使用ES模块语法
- `moduleResolution: "bundler"` - 与现代打包工具兼容

#### 类型检查
- `strict: true` - 启用所有严格类型检查选项
- `noImplicitAny: false` - 允许隐式any类型（降低迁移难度）
- `skipLibCheck: true` - 跳过声明文件的类型检查，加快编译速度

#### 模块解析
- `paths: {"@/*": ["./lib/*"]}` - 配置路径别名，允许使用`@/`导入lib目录下的模块
- `resolveJsonModule: true` - 允许直接导入JSON文件

#### 构建性能
- `incremental: true` - 启用增量编译，加快后续构建速度
- `noEmit: true` - 不生成输出文件（由其他工具处理构建）

#### 其他重要选项
- `outDir: "./dist"` - 指定输出目录
- `isolatedModules: true` - 确保每个文件可独立编译，与Babel等工具兼容
- `jsx: "react-jsx"` - 使用新的JSX转换
- `jsxImportSource: "hono/jsx"` - 指定JSX工厂函数来源

这些配置确保了RSSHub能够高效地编译和运行，同时保持代码质量和开发体验。

**Section sources**
- [tsconfig.json](file://tsconfig.json#L1-L24)

## 应用启动、停止与重启

RSSHub提供了多种启动方式，适应不同的运行环境和需求。

### 启动脚本配置

`package.json`中的scripts字段定义了各种启动命令：

```json
"scripts": {
    "dev": "cross-env NODE_ENV=dev NODE_OPTIONS='--max-http-header-size=32768' tsx watch --inspect --clear-screen=false lib/index.ts",
    "start": "cross-env NODE_ENV=production NODE_OPTIONS='--max-http-header-size=32768' node dist/index.mjs"
}
```

### 开发环境启动

```bash
# 开发模式启动（自动重启）
pnpm dev

# 或使用npm
npm run dev
```

开发模式特点：
- 使用`tsx`运行时直接执行TypeScript
- 启用文件监听，代码更改后自动重启
- 设置调试检查点（--inspect）
- 更大的HTTP头大小限制

### 生产环境启动

```bash
# 构建项目
pnpm build

# 启动应用
pnpm start

# 或直接使用node
node dist/index.mjs
```

生产环境启动流程：
1. 首先执行`pnpm build`编译TypeScript代码到`dist/`目录
2. 然后使用Node.js直接运行编译后的JavaScript文件

### 环境变量配置

创建`.env`文件配置应用参数：

```env
NODE_ENV=production
PORT=1200
CACHE_TYPE=memory
```

### 停止应用

```bash
# 如果是前台运行，使用Ctrl+C
# 如果是后台运行，使用kill命令
kill <进程ID>

# 或使用pkill
pkill -f "node dist/index.mjs"
```

### 重启应用

```bash
# 停止并重新启动
pnpm stop && pnpm start

# 或直接重启（如果使用进程管理器）
# PM2: pm2 restart rsshub
# Systemd: systemctl restart rsshub
```

**Section sources**
- [package.json](file://package.json#L28-L48)
- [lib/index.ts](file://lib/index.ts#L1-L64)

## PM2进程管理集成

PM2是Node.js应用的高级进程管理器，提供守护进程、负载均衡和监控功能。

### PM2安装

```bash
# 全局安装PM2
pnpm add -g pm2

# 或使用npm
npm install -g pm2
```

### PM2配置文件

创建`ecosystem.config.js`配置文件：

```javascript
module.exports = {
    apps: [
        {
            name: 'rsshub',
            script: 'dist/index.mjs',
            instances: 'max',
            exec_mode: 'cluster',
            env: {
                NODE_ENV: 'production',
                PORT: 1200,
                CACHE_TYPE: 'memory'
            },
            max_memory_restart: '1G',
            autorestart: true,
            watch: false,
            ignore_watch: ['node_modules', 'logs'],
            error_file: 'logs/err.log',
            out_file: 'logs/out.log',
            log_file: 'logs/combined.log',
            time: true
        }
    ]
};
```

### 使用PM2启动RSSHub

```bash
# 构建项目
pnpm build

# 使用PM2启动
pm2 start ecosystem.config.js

# 或直接启动
pm2 start dist/index.mjs --name rsshub --node-args="--max-http-header-size=32768" -- --env production
```

### PM2常用命令

```bash
# 启动应用
pm2 start ecosystem.config.js

# 停止应用
pm2 stop rsshub

# 重启应用
pm2 restart rsshub

# 查看应用状态
pm2 list

# 查看日志
pm2 logs rsshub

# 监控应用
pm2 monit

# 保存当前进程列表
pm2 save

# 开机自启
pm2 startup
pm2 save
```

### PM2优势
- **自动重启**：应用崩溃时自动重启
- **负载均衡**：集群模式下自动分配请求
- **内存监控**：达到内存限制时自动重启
- **日志管理**：集中管理应用日志
- **开机自启**：系统重启后自动启动应用
- **监控界面**：提供实时性能监控

**Section sources**
- [lib/index.ts](file://lib/index.ts#L1-L64)
- [package.json](file://package.json#L28-L48)

## 系统服务配置

为确保RSSHub在系统启动时自动运行并能自动重启，建议配置为系统服务。

### 创建系统服务文件

创建`/etc/systemd/system/rsshub.service`：

```ini
[Unit]
Description=RSSHub Service
After=network.target

[Service]
Type=simple
User=rsshub
WorkingDirectory=/path/to/rsshub
ExecStart=/usr/bin/node dist/index.mjs
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=1200
Environment=CACHE_TYPE=redis
StandardOutput=journal
StandardError=journal
SyslogIdentifier=rsshub

[Install]
WantedBy=multi-user.target
```

### Ansible部署示例

RSSHub提供了Ansible部署脚本，包含服务配置：

```ini
# scripts/ansible/rsshub.service
[Unit]
Description=RSSHub
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/RSSHub
ExecStart=/usr/bin/pnpm start
Restart=always
RestartSec=3
EnvironmentFile=/opt/RSSHub/scripts/ansible/rsshub.env

[Install]
WantedBy=multi-user.target
```

配合环境变量文件`rsshub.env`：

```env
NODE_ENV=production
CACHE_TYPE=redis
PUPPETEER_WS_ENDPOINT=ws://localhost:3000
```

### 服务管理命令

```bash
# 重新加载systemd配置
sudo systemctl daemon-reexec

# 启动服务
sudo systemctl start rsshub

# 停止服务
sudo systemctl stop rsshub

# 重启服务
sudo systemctl restart rsshub

# 查看服务状态
sudo systemctl status rsshub

# 设置开机自启
sudo systemctl enable rsshub

# 查看服务日志
sudo journalctl -u rsshub -f
```

### 服务配置要点
- `Restart=always`：确保服务异常退出后自动重启
- `RestartSec=10`：重启间隔时间
- `Environment`：设置必要的环境变量
- `WorkingDirectory`：指定工作目录
- `User`：以非root用户运行，提高安全性

**Section sources**
- [scripts/ansible/rsshub.service](file://scripts/ansible/rsshub.service)
- [scripts/ansible/rsshub.env](file://scripts/ansible/rsshub.env)

## 配置文件详解

RSSHub的配置主要通过环境变量实现，核心配置在`lib/config.ts`中定义。

### 主要配置项

#### 应用配置
- `DISALLOW_ROBOT`：是否禁止爬虫访问
- `ENABLE_CLUSTER`：是否启用集群模式
- `IS_PACKAGE`：是否为打包版本

#### 网络配置
- `PORT`：监听端口（默认1200）
- `LISTEN_INADDR_ANY`：是否允许外部访问
- `REQUEST_TIMEOUT`：请求超时时间

#### 缓存配置
- `CACHE_TYPE`：缓存类型（memory/redis）
- `CACHE_EXPIRE`：路由缓存时间
- `REDIS_URL`：Redis连接地址

#### 代理配置
- `PROXY_URI`：代理服务器地址
- `PROXY_STRATEGY`：代理策略（all/on_retry）

#### 安全配置
- `ACCESS_KEY`：访问密钥，用于保护路由
- `ALLOW_ORIGIN`：CORS允许的来源

### 配置加载机制

`lib/config.ts`文件实现了配置的加载和类型转换：

```typescript
const toBoolean = (value: string | undefined, defaultValue: boolean) => {
    if (value === undefined) {
        return defaultValue;
    } else {
        return value === '' || value === '0' || value === 'false' ? false : !!value;
    }
};

const toInt = (value: string | undefined, defaultValue?: number) => 
    (value === undefined ? defaultValue : Number.parseInt(value));
```

### 配置优先级

1. 环境变量（最高优先级）
2. `.env`文件
3. 代码中的默认值

### 推荐生产配置

```env
NODE_ENV=production
PORT=1200
CACHE_TYPE=redis
REDIS_URL=redis://localhost:6379/
REQUEST_TIMEOUT=30000
ENABLE_CLUSTER=true
```

这些配置确保了RSSHub在生产环境中的稳定性和性能。

**Section sources**
- [lib/config.ts](file://lib/config.ts#L1-L800)
- [lib/index.ts](file://lib/index.ts#L8-L12)
- [lib/utils/logger.ts](file://lib/utils/logger.ts#L5-L8)