# 启动方式

<cite>
**本文档引用的文件**
- [lib/app.ts](file://lib/app.ts)
- [lib/server.ts](file://lib/server.ts)
- [lib/index.ts](file://lib/index.ts)
- [lib/app-bootstrap.tsx](file://lib/app-bootstrap.tsx)
- [lib/config.ts](file://lib/config.ts)
- [package.json](file://package.json)
- [docker-compose.yml](file://docker-compose.yml)
</cite>

## 目录
1. [简介](#简介)
2. [启动方式概述](#启动方式概述)
3. [核心启动文件分析](#核心启动文件分析)
4. [配置参数详解](#配置参数详解)
5. [健康检查与就绪探针](#健康检查与就绪探针)
6. [常见错误及解决方案](#常见错误及解决方案)
7. [总结](#总结)

## 简介
RSSHub 是一个强大的 RSS 生成器，支持多种启动方式。本文档详细介绍了 RSSHub 的各种启动方法，包括开发模式和生产模式的区别，核心启动文件的作用和调用关系，以及自定义启动参数的配置方法。

## 启动方式概述

RSSHub 提供了多种启动方式，主要通过 pnpm 命令来执行。根据不同的环境需求，可以选择开发模式或生产模式启动应用。

```mermaid
flowchart TD
Start([启动应用]) --> CheckMode["检查启动模式"]
CheckMode --> |开发模式| DevMode["使用 dev 脚本启动"]
CheckMode --> |生产模式| ProdMode["使用 start 脚本启动"]
DevMode --> DevConfig["设置开发环境变量"]
ProdMode --> ProdConfig["设置生产环境变量"]
DevConfig --> StartServer["启动服务器"]
ProdConfig --> StartServer
StartServer --> ServerRunning["服务器运行中"]
```

**Diagram sources**
- [package.json](file://package.json#L34-L43)

### 开发模式启动
在开发模式下，可以使用以下命令启动 RSSHub：

```bash
pnpm dev
```

此命令会执行 package.json 中定义的 dev 脚本，设置开发环境变量并启动服务器。开发模式的特点包括：
- 启用调试信息输出
- 使用 tsx 工具进行热重载
- 设置较大的 HTTP 头部大小限制

### 生产模式启动
在生产环境中，应使用以下命令启动 RSSHub：

```bash
pnpm start
```

此命令会执行 package.json 中定义的 start 脚本，设置生产环境变量并启动编译后的服务器。生产模式的特点包括：
- 性能优化
- 错误处理更加严格
- 日志记录更加详细

**Section sources**
- [package.json](file://package.json#L34-L43)

## 核心启动文件分析

RSSHub 的启动过程涉及多个核心文件，它们之间有明确的调用关系。理解这些文件的作用对于掌握 RSSHub 的启动机制至关重要。

### lib/app.ts 文件
`lib/app.ts` 文件是应用的主要入口点之一。它的主要作用是确保请求重写器在应用启动前运行。

```mermaid
classDiagram
class App {
+import '@/utils/request-rewriter'
+export default (await import('./app-bootstrap')).default
}
App --> RequestRewriter : "确保先运行"
App --> AppBootstrap : "导入并导出"
```

**Diagram sources**
- [lib/app.ts](file://lib/app.ts#L1-L5)

### lib/server.ts 文件
`lib/server.ts` 文件主要用于兼容 Vercel 部署环境。它与 `lib/app.ts` 类似，但采用了不同的导入方式。

```mermaid
classDiagram
class Server {
+import '@/utils/request-rewriter'
+export { default } from './app-bootstrap'
}
Server --> RequestRewriter : "确保先运行"
Server --> AppBootstrap : "直接导出"
```

**Diagram sources**
- [lib/server.ts](file://lib/server.ts#L1-L5)

### lib/app-bootstrap.tsx 文件
`lib/app-bootstrap.tsx` 文件是应用的核心配置文件，负责初始化 Hono 应用实例并配置中间件。

```mermaid
classDiagram
class AppBootstrap {
+new Hono()
+use(trimTrailingSlash)
+use(compress)
+use(jsxRenderer)
+use(logger)
+use(trace)
+use(sentry)
+use(accessControl)
+use(debug)
+use(template)
+use(header)
+use(antiHotlink)
+use(parameter)
+use(cache)
+route('/', registry)
+route('/api', api)
+notFound(notFoundHandler)
+onError(errorHandler)
}
AppBootstrap --> Hono : "创建实例"
AppBootstrap --> Middleware : "配置中间件"
AppBootstrap --> Registry : "注册路由"
AppBootstrap --> ErrorHandler : "错误处理"
```

**Diagram sources**
- [lib/app-bootstrap.tsx](file://lib/app-bootstrap.tsx#L1-L54)

### 调用关系分析
这些核心文件之间的调用关系如下：

```mermaid
sequenceDiagram
participant CLI as "命令行"
participant PackageJSON as "package.json"
participant Index as "lib/index.ts"
participant App as "lib/app.ts"
participant Server as "lib/server.ts"
participant AppBootstrap as "lib/app-bootstrap.tsx"
CLI->>PackageJSON : 执行 pnpm dev/start
PackageJSON->>Index : 调用 lib/index.ts
Index->>App : 导入 app
App->>AppBootstrap : 动态导入并导出
Index->>Config : 导入 config
Index->>Logger : 导入 logger
Index->>getLocalhostAddress : 获取本地地址
Index->>serve : 启动服务器
AppBootstrap->>Hono : 创建应用实例
AppBootstrap->>Middleware : 配置中间件
AppBootstrap->>Registry : 注册路由
```

**Diagram sources**
- [lib/index.ts](file://lib/index.ts#L1-L64)
- [lib/app.ts](file://lib/app.ts#L1-L5)
- [lib/server.ts](file://lib/server.ts#L1-L5)
- [lib/app-bootstrap.tsx](file://lib/app-bootstrap.tsx#L1-L54)

**Section sources**
- [lib/index.ts](file://lib/index.ts#L1-L64)
- [lib/app.ts](file://lib/app.ts#L1-L5)
- [lib/server.ts](file://lib/server.ts#L1-L5)
- [lib/app-bootstrap.tsx](file://lib/app-bootstrap.tsx#L1-L54)

## 配置参数详解

RSSHub 提供了丰富的配置选项，可以通过环境变量进行自定义设置。这些配置主要在 `lib/config.ts` 文件中定义和处理。

### 端口和主机绑定
可以通过以下环境变量配置服务器的监听端口和主机：

```mermaid
flowchart TD
ConfigStart([配置开始]) --> PortConfig["PORT 环境变量"]
ConfigStart --> HostConfig["LISTEN_INADDR_ANY 环境变量"]
PortConfig --> |设置| SetPort["设置监听端口"]
HostConfig --> |设置| SetHost["设置主机绑定"]
SetPort --> CheckDefault["检查默认值"]
SetHost --> CheckDefault
CheckDefault --> |无值| UseDefault["使用默认值"]
CheckDefault --> |有值| UseCustom["使用自定义值"]
UseDefault --> Port1200["端口: 1200"]
UseDefault --> HostAny["主机: 所有接口"]
UseCustom --> CustomPort["自定义端口"]
UseCustom --> CustomHost["自定义主机"]
```

相关配置项：
- **PORT**: 设置服务器监听端口，默认值为 1200
- **LISTEN_INADDR_ANY**: 是否允许公网连接，取值为 0 或 1，默认为 1（允许）

**Section sources**
- [lib/config.ts](file://lib/config.ts#L23-L25)

### 日志级别配置
日志系统提供了详细的配置选项，可以控制日志的输出级别和格式：

```mermaid
flowchart TD
LoggerStart([日志配置]) --> LogLevel["LOGGER_LEVEL 环境变量"]
LoggerStart --> DebugInfo["DEBUG_INFO 环境变量"]
LoggerStart --> ShowTimestamp["SHOW_LOGGER_TIMESTAMP 环境变量"]
LogLevel --> |设置| SetLevel["设置日志级别"]
DebugInfo --> |设置| SetDebug["设置调试信息"]
ShowTimestamp --> |设置| SetTimestamp["设置时间戳显示"]
SetLevel --> InfoLevel["info 级别"]
SetDebug --> DebugTrue["永久显示"]
SetDebug --> DebugFalse["永远隐藏"]
SetDebug --> DebugString["条件显示"]
SetTimestamp --> TimestampYes["显示时间戳"]
SetTimestamp --> TimestampNo["不显示时间戳"]
```

相关配置项：
- **LOGGER_LEVEL**: 日志级别，可选值包括 'info'、'error' 等
- **DEBUG_INFO**: 是否显示调试信息，取值 'true' 永久显示，'false' 永远隐藏，或指定字符串条件显示
- **SHOW_LOGGER_TIMESTAMP**: 是否显示日志时间戳

**Section sources**
- [lib/config.ts](file://lib/config.ts#L44-L50)

### 缓存配置
缓存系统支持多种缓存类型和策略配置：

```mermaid
flowchart TD
CacheStart([缓存配置]) --> CacheType["CACHE_TYPE 环境变量"]
CacheStart --> CacheExpire["CACHE_EXPIRE 环境变量"]
CacheStart --> CacheContentExpire["CACHE_CONTENT_EXPIRE 环境变量"]
CacheStart --> RedisUrl["REDIS_URL 环境变量"]
CacheType --> |设置| SetType["设置缓存类型"]
CacheExpire --> |设置| SetExpire["设置路由缓存时间"]
CacheContentExpire --> |设置| SetContentExpire["设置内容缓存时间"]
RedisUrl --> |设置| SetRedis["设置 Redis 连接"]
SetType --> Memory["内存缓存"]
SetType --> Redis["Redis 缓存"]
SetType --> None["无缓存"]
SetExpire --> Route5Min["路由缓存: 5分钟"]
SetContentExpire --> Content1Hour["内容缓存: 1小时"]
SetRedis --> RedisDefault["redis://localhost:6379/"]
```

相关配置项：
- **CACHE_TYPE**: 缓存类型，支持 'memory' 和 'redis'，设为空可以禁止缓存
- **CACHE_EXPIRE**: 路由缓存时间，单位为秒，默认 5 分钟
- **CACHE_CONTENT_EXPIRE**: 不变内容缓存时间，单位为秒，默认 1 小时
- **REDIS_URL**: Redis 连接地址，默认为 'redis://localhost:6379/'

**Section sources**
- [lib/config.ts](file://lib/config.ts#L22-L28)

## 健康检查与就绪探针

RSSHub 支持通过 Docker Compose 配置健康检查和就绪探针，确保服务的稳定运行。

### Docker 健康检查配置
在 `docker-compose.yml` 文件中，可以为各个服务配置健康检查：

```mermaid
flowchart TD
DockerStart([Docker 启动]) --> Browserless["browserless 服务"]
DockerStart --> Redis["redis 服务"]
Browserless --> HealthCheck["健康检查配置"]
Redis --> HealthCheck
HealthCheck --> TestCommand["测试命令"]
HealthCheck --> Interval["检查间隔"]
HealthCheck --> Timeout["超时时间"]
HealthCheck --> Retries["重试次数"]
TestCommand --> BrowserlessTest["curl -f http://localhost:3000/pressure"]
TestCommand --> RedisTest["redis-cli ping"]
Interval --> Browserless30s["30秒"]
Interval --> Redis30s["30秒"]
Timeout --> Browserless10s["10秒"]
Timeout --> Redis10s["10秒"]
Retries --> Browserless3["3次"]
Retries --> Redis5["5次"]
```

具体配置示例：
- **browserless 服务**: 使用 curl 命令检查 /pressure 端点
- **redis 服务**: 使用 redis-cli ping 命令检查 Redis 状态
- 检查间隔均为 30 秒，超时时间为 10 秒

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L36-L62)

### 代理健康检查
对于代理服务，RSSHub 还实现了专门的健康检查机制：

```mermaid
flowchart TD
ProxyStart([代理健康检查]) --> HealthCheckInterval["healthCheckInterval 配置"]
HealthCheckInterval --> |默认值| Default60s["60000毫秒"]
HealthCheckInterval --> SetInterval["设置检查间隔"]
SetInterval --> CreateTimer["创建定时器"]
CreateTimer --> CheckLoop["定期检查循环"]
CheckLoop --> CheckProxy["检查每个代理"]
CheckProxy --> IsActive["代理是否活跃"]
IsActive --> |否| CheckTime["检查上次失败时间"]
CheckTime --> |超过间隔| Reactivate["重新激活代理"]
Reactivate --> LogInfo["记录日志: 代理重新激活"]
IsActive --> |是| NextProxy["检查下一个代理"]
```

相关配置项：
- **PROXY_HEALTH_CHECK_INTERVAL**: 代理健康检查间隔，默认 60000 毫秒
- 健康检查会定期检查所有代理的状态，并在满足条件时重新激活失败的代理

**Section sources**
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L52-L67)

## 常见错误及解决方案

在启动 RSSHub 时可能会遇到各种问题，以下是常见错误及其解决方案。

### 端口冲突
当指定的端口已被其他进程占用时，会出现端口冲突错误。

```mermaid
flowchart TD
PortError([端口冲突]) --> CheckPort["检查端口占用"]
CheckPort --> |被占用| PortOccupied["端口已被占用"]
PortOccupied --> Solution1["解决方案1: 更改端口"]
PortOccupied --> Solution2["解决方案2: 终止占用进程"]
Solution1 --> SetNewPort["设置新的 PORT 环境变量"]
Solution2 --> FindProcess["查找占用进程"]
FindProcess --> KillProcess["终止进程"]
Solution1 --> Success["启动成功"]
Solution2 --> Success
```

解决方案：
1. 更改端口：通过设置 PORT 环境变量使用其他端口
2. 终止占用进程：使用系统命令查找并终止占用该端口的进程

**Section sources**
- [lib/config.ts](file://lib/config.ts#L23-L25)

### 依赖缺失
当必要的依赖项未正确安装时，会导致启动失败。

```mermaid
flowchart TD
DependencyError([依赖缺失]) --> CheckDependencies["检查依赖项"]
CheckDependencies --> |缺失| MissingDependency["发现缺失依赖"]
MissingDependency --> Solution1["解决方案1: 安装依赖"]
MissingDependency --> Solution2["解决方案2: 检查 package.json"]
Solution1 --> RunInstall["运行 pnpm install"]
Solution2 --> VerifyConfig["验证配置文件"]
RunInstall --> Success["安装成功"]
VerifyConfig --> FixConfig["修复配置"]
Success --> Restart["重启应用"]
FixConfig --> Restart
```

解决方案：
1. 安装依赖：运行 `pnpm install` 命令安装所有依赖
2. 检查配置：确认 package.json 文件中的依赖项是否完整

**Section sources**
- [package.json](file://package.json#L59-L147)

### 配置文件错误
当环境变量配置不正确时，可能导致应用无法正常启动。

```mermaid
flowchart TD
ConfigError([配置错误]) --> CheckEnv["检查环境变量"]
CheckEnv --> |错误| InvalidConfig["发现无效配置"]
InvalidConfig --> Solution1["解决方案1: 检查变量名"]
InvalidConfig --> Solution2["解决方案2: 检查变量值"]
Solution1 --> VerifyName["验证环境变量名称"]
Solution2 --> VerifyValue["验证环境变量值类型"]
VerifyName --> CorrectName["修正变量名"]
VerifyValue --> CorrectValue["修正变量值"]
CorrectName --> Success["配置正确"]
CorrectValue --> Success
```

解决方案：
1. 检查变量名：确保环境变量名称拼写正确
2. 检查变量值：确保环境变量值的类型和格式正确

**Section sources**
- [lib/config.ts](file://lib/config.ts#L5-L237)

## 总结
RSSHub 提供了灵活多样的启动方式和丰富的配置选项。通过理解核心启动文件的作用和调用关系，可以更好地掌握应用的启动机制。合理配置各种参数，设置适当的健康检查，能够确保 RSSHub 稳定可靠地运行。遇到问题时，可以根据具体的错误类型采取相应的解决方案。