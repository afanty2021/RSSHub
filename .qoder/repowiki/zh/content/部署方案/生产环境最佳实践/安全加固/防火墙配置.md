# 防火墙配置

<cite>
**本文档引用的文件**  
- [Dockerfile](file://Dockerfile#L181)
- [docker-compose.yml](file://docker-compose.yml#L9)
- [fly.toml](file://fly.toml#L4)
- [lib/config.ts](file://lib/config.ts#L726)
- [lib/middleware/header.ts](file://lib/middleware/header.ts#L11)
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts#L19)
- [flake.nix](file://flake.nix#L128-L131)
- [scripts/ansible/README.md](file://scripts/ansible/README.md#L3)
</cite>

## 目录
1. [简介](#简介)
2. [端口暴露最佳实践](#端口暴露最佳实践)
3. [Docker网络配置](#docker网络配置)
4. [反向代理配置建议](#反向代理配置建议)
5. [容器安全加固措施](#容器安全加固措施)
6. [网络安全监控建议](#网络安全监控建议)
7. [结论](#结论)

## 简介
RSSHub是一个开源的RSS生成器，能够将各种内容源转换为RSS订阅。本防火墙配置文档旨在为RSSHub生产环境提供全面的安全配置指南。通过分析项目代码库，我们将详细介绍如何配置防火墙规则、Docker网络、反向代理以及容器安全加固措施，确保系统在提供服务的同时保持最高级别的安全性。文档涵盖了从端口暴露的最佳实践到入侵检测系统集成的各个方面，帮助运维人员建立一个安全可靠的RSSHub部署环境。

## 端口暴露最佳实践
在RSSHub生产环境中，应遵循最小权限原则，仅开放必要的服务端口。根据Dockerfile和docker-compose.yml文件的分析，RSSHub容器默认暴露1200端口用于HTTP服务。在生产部署中，应通过反向代理（如Nginx或Caddy）将外部请求转发到此端口，而不是直接暴露容器端口到公网。fly.toml配置文件显示，内部端口设置为1200，并强制启用HTTPS，这符合安全最佳实践。在lib/config.ts中，端口配置默认为1200，可通过环境变量PORT进行修改。建议在防火墙规则中仅允许反向代理服务器访问容器的1200端口，同时在外部防火墙中仅开放80和443端口用于HTTP/HTTPS流量。对于Redis等内部服务，应完全限制在内部网络中，不对外暴露任何端口。

**Section sources**
- [Dockerfile](file://Dockerfile#L181)
- [docker-compose.yml](file://docker-compose.yml#L9)
- [fly.toml](file://fly.toml#L4)
- [lib/config.ts](file://lib/config.ts#L726)

## Docker网络配置
RSSHub的Docker网络配置应采用自定义网络模式以增强安全性。在docker-compose.yml文件中，定义了rsshub、real-browser、browserless和redis四个服务，它们共享同一个Docker网络。这种配置允许服务间通过内部网络通信，而无需暴露端口到主机。建议创建专用的Docker网络，将RSSHub主服务、浏览器服务和Redis缓存服务置于同一内部网络中。对于端口映射，应仅将RSSHub服务的1200端口映射到主机的特定端口，并通过反向代理进行访问控制。其他服务如browserless（3000端口）和real-browser（3001端口）不应直接映射到主机端口，而应仅通过内部网络被RSSHub服务调用。在flake.nix配置中，openFirewall选项默认为false，这符合安全原则，需要时才显式开启防火墙端口。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L2-L48)
- [flake.nix](file://flake.nix#L128-L131)

## 反向代理配置建议
反向代理是RSSHub生产环境安全架构的关键组件。根据scripts/ansible/README.md文件，推荐使用Caddy 2作为反向代理服务器，它能自动处理SSL证书的获取和续期。对于Nginx配置，应设置严格的安全头信息，包括Content-Security-Policy、X-Content-Type-Options、X-Frame-Options和Strict-Transport-Security。在lib/middleware/header.ts中，RSSHub已经设置了X-Content-Type-Options: nosniff和Cache-Control等安全头，反向代理应保留并增强这些设置。SSL/TLS配置应启用TLS 1.2及以上版本，禁用弱加密套件，并配置合理的会话超时。建议使用Let's Encrypt证书，并设置自动续期。反向代理还应配置访问日志和错误日志，便于安全审计和故障排查。对于访问控制，反向代理可以与RSSHub的accessKey机制协同工作，提供多层安全防护。

**Section sources**
- [lib/middleware/header.ts](file://lib/middleware/header.ts#L11)
- [scripts/ansible/README.md](file://scripts/ansible/README.md#L3)
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts#L19)

## 容器安全加固措施
RSSHub容器的安全加固应从多个层面实施。首先，在Dockerfile中，基础镜像使用node:24-bookworm-slim，这是一个精简的生产环境镜像，减少了攻击面。容器应以非root用户运行，flake.nix配置中指定了rsshub用户和组，这符合最小权限原则。建议将容器文件系统设置为只读，除了必要的数据目录。在资源限制方面，应通过Docker的资源限制功能设置CPU和内存使用上限，防止资源耗尽攻击。在security配置中，应启用NoNewPrivileges、PrivateTmp、ProtectSystem等安全特性。对于敏感信息，应使用环境变量而非硬编码，并通过Docker Secrets或配置管理工具进行安全传递。定期更新基础镜像和依赖包，及时修复已知漏洞。在Dockerfile中，通过多阶段构建减少了最终镜像的大小和复杂性，这也是安全加固的重要措施。

**Section sources**
- [Dockerfile](file://Dockerfile#L137-L161)
- [flake.nix](file://flake.nix#L247-L254)

## 网络安全监控建议
RSSHub生产环境的网络安全监控应包括异常流量检测和入侵检测系统的集成。建议部署网络流量分析工具，监控进出RSSHub服务的流量模式，识别异常请求频率、异常用户代理或异常访问模式。可以集成开源入侵检测系统如Suricata或Snort，配置针对Web应用攻击的检测规则。在应用层面，lib/middleware/access-control.ts实现了基于accessKey的访问控制，所有访问尝试都应记录到安全日志中。建议配置集中式日志管理系统，收集RSSHub、反向代理和容器运行时的日志，进行关联分析。对于Redis等依赖服务，也应监控其访问日志，防止未授权访问。定期进行安全扫描和渗透测试，识别潜在的安全漏洞。设置告警机制，当检测到可疑活动时及时通知运维人员。此外，应定期审查防火墙规则和访问控制列表，确保其符合当前的安全策略。

**Section sources**
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts#L7)
- [docker-compose.yml](file://docker-compose.yml#L17-L20)

## 结论
本防火墙配置文档为RSSHub生产环境提供了全面的安全指南。通过遵循端口暴露最佳实践，仅开放必要的1200端口并通过反向代理进行访问控制，可以有效减少攻击面。采用自定义Docker网络配置，将服务间通信限制在内部网络中，增强了整体安全性。使用Caddy或Nginx作为反向代理，配置严格的安全头和SSL/TLS加密，保护了数据传输安全。容器安全加固措施，包括非root用户运行、资源限制和安全特性启用，进一步提升了容器的安全性。最后，通过集成网络安全监控和入侵检测系统，可以及时发现和响应潜在的安全威胁。建议定期审查和更新安全配置，适应不断变化的安全环境，确保RSSHub服务的持续安全运行。