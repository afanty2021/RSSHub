# 负载均衡

<cite>
**本文档中引用的文件**  
- [config.ts](file://lib/config.ts)
- [docker-compose.yml](file://docker-compose.yml)
- [fly.toml](file://fly.toml)
- [healthz.ts](file://lib/routes/healthz.ts)
- [registry.ts](file://lib/registry.ts)
</cite>

## 目录
1. [引言](#引言)
2. [健康检查配置](#健康检查配置)
3. [负载均衡算法](#负载均衡算法)
4. [SSL/TLS 终止配置](#ssltls-终止配置)
5. [智能路由配置](#智能路由配置)
6. [监控与性能调优](#监控与性能调优)
7. [部署示例](#部署示例)
8. [结论](#结论)

## 引言

RSSHub 是一个开源的 RSS 生成器，能够为各种内容源生成 RSS 订阅。在高并发场景下，为了确保服务的高可用性和稳定性，通常需要部署多个 RSSHub 实例并通过负载均衡器进行流量分发。本文档详细说明如何配置 HAProxy 或其他云服务商的负载均衡服务来分发 RSSHub 请求，涵盖健康检查、负载均衡算法、SSL/TLS 终止、智能路由以及监控与性能调优等方面。

**Section sources**
- [README.md](file://README.md)

## 健康检查配置

为了确保后端 RSSHub 服务的可用性，负载均衡器需要定期对后端实例进行健康检查。RSSHub 提供了内置的健康检查端点 `/healthz`，该端点返回简单的文本响应 "ok"，可用于判断服务是否正常运行。

在 `docker-compose.yml` 和 `fly.toml` 配置文件中，均定义了健康检查机制。例如，在 `docker-compose.yml` 中，`rsshub` 服务的健康检查配置如下：

```yaml
healthcheck:
  test: ['CMD', 'curl', '-f', 'http://localhost:1200/healthz']
  interval: 30s
  timeout: 10s
  retries: 3
```

此配置表示每隔 30 秒使用 `curl` 命令检查 `/healthz` 端点，超时时间为 10 秒，连续失败 3 次则认为服务不健康。

在 `fly.toml` 中，健康检查配置如下：

```toml
[[http_service.checks]]
grace_period = "10s"
interval = "30s"
method = "GET"
timeout = "5s"
path = "/healthz"
```

此配置同样定义了每 30 秒通过 GET 请求检查 `/healthz` 端点。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L16-L21)
- [fly.toml](file://fly.toml#L10-L15)
- [healthz.ts](file://lib/routes/healthz.ts)

## 负载均衡算法

负载均衡器支持多种算法来分发流量，常见的算法包括轮询、最少连接和 IP 哈希。选择合适的算法取决于具体的应用场景和需求。

### 轮询（Round Robin）

轮询算法将请求依次分发到每个后端服务器，适用于后端服务器性能相近且负载较为均衡的场景。

### 最少连接（Least Connections）

最少连接算法将请求分发到当前连接数最少的服务器，适用于处理时间不一致的请求，能够有效避免某些服务器过载。

### IP 哈希（IP Hash）

IP 哈希算法根据客户端 IP 地址的哈希值将请求分发到固定的服务器，适用于需要会话保持的场景，确保同一客户端的请求始终由同一服务器处理。

对于 RSSHub 这类无状态服务，推荐使用轮询或最少连接算法，以实现最佳的负载均衡效果。

**Section sources**
- [CLAUDE.md](file://CLAUDE.md)

## SSL/TLS 终止配置

为了确保通信安全，建议在负载均衡器上配置 SSL/TLS 终止。这样可以将 HTTPS 请求解密后以 HTTP 协议转发到后端 RSSHub 实例，减轻后端服务器的加密解密负担。

在 `fly.toml` 配置文件中，通过设置 `force_https = true` 强制启用 HTTPS：

```toml
[http_service]
internal_port = 1200
force_https = true
```

此配置确保所有外部请求都必须通过 HTTPS 协议访问，提升了通信的安全性。

**Section sources**
- [fly.toml](file://fly.toml#L4-L5)

## 智能路由配置

基于请求特征的智能路由配置可以根据 URL 路径或请求头等信息将流量分发到不同的后端服务。虽然 RSSHub 本身不直接提供复杂的路由逻辑，但可以通过负载均衡器实现这一功能。

例如，可以配置负载均衡器根据 URL 路径将特定类型的请求（如 `/api/*`）路由到专门处理 API 请求的后端集群，而将普通 RSS 请求路由到另一个集群。此外，还可以根据请求头中的 `User-Agent` 或其他自定义头信息进行流量分发，实现更精细化的路由控制。

**Section sources**
- [registry.ts](file://lib/registry.ts#L254)

## 监控与性能调优

为了确保高并发场景下的稳定性能，必须对负载均衡器和后端服务进行全面的监控和性能调优。

### 监控

- **健康检查状态**：实时监控后端实例的健康状况，及时发现并隔离故障节点。
- **请求速率和响应时间**：跟踪每秒请求数和平均响应时间，识别性能瓶颈。
- **错误率**：监控 HTTP 错误码（如 5xx）的比例，及时发现服务异常。

### 性能调优

- **连接池管理**：合理配置负载均衡器的连接池大小，避免因连接耗尽导致性能下降。
- **缓存策略**：利用 RSSHub 的缓存机制（如 Redis 缓存），减少对后端服务的重复请求。
- **资源限制**：根据实际负载情况调整后端实例的 CPU 和内存资源，确保服务稳定运行。

通过持续监控和优化，可以显著提升 RSSHub 服务的整体性能和可靠性。

**Section sources**
- [config.ts](file://lib/config.ts#L263-L274)

## 部署示例

以下是一个使用 Docker Compose 部署 RSSHub 并配置健康检查的示例：

```yaml
version: '3'
services:
  rsshub:
    image: diygod/rsshub
    restart: always
    ports:
      - '1200:1200'
    environment:
      NODE_ENV: production
      CACHE_TYPE: redis
      REDIS_URL: 'redis://redis:6379/'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:1200/healthz']
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis

  redis:
    image: redis:alpine
    restart: always
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5s

volumes:
  redis-data:
```

此配置文件定义了一个包含 RSSHub 和 Redis 的简单部署环境，并为两个服务都配置了健康检查。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml)

## 结论

通过合理配置负载均衡器的健康检查、选择适当的负载均衡算法、启用 SSL/TLS 终止、实施智能路由以及进行有效的监控和性能调优，可以显著提升 RSSHub 服务的可用性、安全性和性能。本文档提供的配置指南和示例可作为部署和管理 RSSHub 集群的重要参考。