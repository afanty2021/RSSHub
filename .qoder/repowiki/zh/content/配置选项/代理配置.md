# 代理配置

<cite>
**本文档引用的文件**   
- [config.ts](file://lib/config.ts)
- [unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts)
- [index.ts](file://lib/utils/proxy/index.ts)
- [pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts)
- [multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts)
- [fetch.ts](file://lib/utils/request-rewriter/fetch.ts)
- [rsshub.env](file://scripts/ansible/rsshub.env)
- [client.ts](file://lib/routes/telegram/tglib/client.ts)
</cite>

## 目录
1. [简介](#简介)
2. [代理配置基础](#代理配置基础)
3. [代理类型配置](#代理类型配置)
4. [高级代理配置](#高级代理配置)
5. [特定路由代理配置](#特定路由代理配置)
6. [代理配置示例](#代理配置示例)
7. [安全考虑](#安全考虑)
8. [性能影响与故障排查](#性能影响与故障排查)
9. [测试方法](#测试方法)
10. [结论](#结论)

## 简介
RSSHub 是一个开源的 RSS 生成器，能够通过代理访问外部资源以绕过网络限制或提高访问速度。本文档详细说明了如何配置 HTTP 代理、HTTPS 代理和 SOCKS 代理，以及如何使用 PAC 脚本进行智能代理选择。此外，还涵盖了代理认证、代理白名单、特定路由代理等高级配置选项，并提供了不同场景下的配置示例。

**Section sources**
- [config.ts](file://lib/config.ts#L28-L29)

## 代理配置基础
RSSHub 支持多种代理配置方式，包括单个代理、多个代理轮换和 PAC 脚本。代理配置主要通过环境变量来设置，这些变量在 `config.ts` 文件中定义。以下是基本的代理配置参数：

- `PROXY_URI`: 单个代理的 URI。
- `PROXY_URIS`: 多个代理的 URI 列表，用逗号分隔。
- `PAC_URI`: PAC 脚本的 URI。
- `PAC_SCRIPT`: 直接提供的 PAC 脚本内容。

当同时设置了 `PAC_URI` 或 `PAC_SCRIPT` 时，将优先使用 PAC 配置。如果未设置 PAC，则会检查 `PROXY_URIS` 是否存在多个代理，若存在则启用多代理轮换功能；否则，使用 `PROXY_URI` 配置的单个代理。

```mermaid
graph TD
A[开始] --> B{是否设置了PAC_URI或PAC_SCRIPT?}
B --> |是| C[使用PAC代理]
B --> |否| D{是否设置了PROXY_URIS且有多个代理?}
D --> |是| E[启用多代理轮换]
D --> |否| F{是否设置了PROXY_URI?}
F --> |是| G[使用单个代理]
F --> |否| H[不使用代理]
```

**Diagram sources **
- [config.ts](file://lib/config.ts#L30-L40)
- [index.ts](file://lib/utils/proxy/index.ts#L60-L79)

## 代理类型配置
### HTTP/HTTPS 代理
HTTP 和 HTTPS 代理是最常见的代理类型，可以通过 `PROXY_URI` 或 `PROXY_URIS` 设置。支持基本认证，格式为 `http://username:password@host:port`。

### SOCKS 代理
SOCKS 代理支持 SOCKS4、SOCKS4a 和 SOCKS5 协议。配置方法与 HTTP/HTTPS 代理类似，只需将协议部分改为 `socks4://`、`socks4a://` 或 `socks5://`。

### PAC 脚本代理
PAC（Proxy Auto-Configuration）脚本允许根据目标 URL 动态选择代理。可以设置 `PAC_URI` 指向远程 PAC 文件，或直接提供 `PAC_SCRIPT` 内容。

```mermaid
classDiagram
class ProxyConfig {
+string proxyUri
+string[] proxyUris
+string pacUri
+string pacScript
+string protocol
+string host
+string port
+string auth
+string url_regex
+string strategy
+number failoverTimeout
+number healthCheckInterval
}
ProxyConfig : +setProxyUri(uri)
ProxyConfig : +setProxyUris(uris)
ProxyConfig : +setPacUri(uri)
ProxyConfig : +setPacScript(script)
```

**Diagram sources **
- [config.ts](file://lib/config.ts#L275-L287)
- [unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L7-L115)

## 高级代理配置
### 代理认证
代理认证通过 `PROXY_AUTH` 环境变量设置，值为 Base64 编码的用户名和密码，格式为 `username:password`。注意，仅 HTTP(S) 代理支持此认证方式。

### 代理白名单
通过 `PROXY_URL_REGEX` 参数定义正则表达式，匹配需要通过代理访问的 URL。默认值为 `.*`，表示所有请求都通过代理。

### 特定路由代理
某些路由可能需要特殊的代理配置。例如，Instagram 路由支持 `IG_PROXY` 环境变量，用于指定 Instagram API 请求的代理。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant RSSHub as "RSSHub"
participant Proxy as "代理服务器"
participant Target as "目标服务器"
Client->>RSSHub : 发起请求
RSSHub->>RSSHub : 解析请求URL
RSSHub->>RSSHub : 匹配PROXY_URL_REGEX
alt 匹配成功
RSSHub->>Proxy : 通过代理转发请求
Proxy->>Target : 转发请求
Target-->>Proxy : 返回响应
Proxy-->>RSSHub : 返回响应
else 不匹配
RSSHub->>Target : 直接请求
Target-->>RSSHub : 返回响应
end
RSSHub-->>Client : 返回最终响应
```

**Diagram sources **
- [config.ts](file://lib/config.ts#L36-L38)
- [fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L79-L88)

## 特定路由代理配置
### Telegram 代理
Telegram 路由支持 MTProto 代理，通过 `TELEGRAM_PROXY_HOST`、`TELEGRAM_PROXY_PORT` 和 `TELEGRAM_PROXY_SECRET` 设置。这在访问被封锁的 Telegram 服务时非常有用。

### Instagram 代理
Instagram 路由支持 `IG_PROXY` 环境变量，用于指定 Instagram API 请求的代理。这对于绕过地理限制特别有效。

```mermaid
flowchart TD
A[Telegram客户端] --> B{是否配置了代理?}
B --> |是| C[设置MTProto代理]
C --> D[连接Telegram服务器]
B --> |否| E[直接连接]
E --> D
D --> F[成功连接]
```

**Diagram sources **
- [client.ts](file://lib/routes/telegram/tglib/client.ts#L25-L33)
- [config.ts](file://lib/config.ts#L593-L597)

## 代理配置示例
### 企业网络环境
在企业网络中，通常需要通过公司代理访问外部资源。配置如下：
```env
PROXY_URI=http://proxy.company.com:8080
PROXY_AUTH=base64encodedcredentials
PROXY_URL_REGEX=^https?://(www\.)?external-service\.com/
```

### 地理限制绕过
为了访问地理受限的内容，可以使用位于目标地区的代理服务器：
```env
PROXY_URIS=socks5://us-proxy1.example.com:1080,socks5://us-proxy2.example.com:1080
PROXY_URL_REGEX=^https?://(www\.)?geo-restricted-content\.com/
```

**Section sources**
- [rsshub.env](file://scripts/ansible/rsshub.env#L1-L4)

## 安全考虑
### 代理服务器的信任问题
选择可信赖的代理服务提供商至关重要，因为代理服务器可以看到所有经过的数据流。建议使用知名且信誉良好的代理服务。

### 流量加密
即使使用代理，也应确保通信使用 HTTPS 加密，防止中间人攻击。避免在非加密连接上传输敏感信息。

**Section sources**
- [unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L64-L80)
- [pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts#L46-L58)

## 性能影响与故障排查
### 性能影响
使用代理可能会增加延迟并降低吞吐量，特别是在高负载情况下。建议定期监控性能指标，如响应时间和错误率。

### 故障排查
常见问题包括代理服务器不可达、认证失败和配置错误。日志记录是诊断问题的关键工具。启用详细日志可以帮助快速定位问题根源。

```mermaid
flowchart LR
A[请求失败] --> B{检查代理状态}
B --> |代理正常| C[检查网络连接]
B --> |代理异常| D[切换到备用代理]
C --> E{网络正常}
E --> |是| F[检查目标服务器]
E --> |否| G[修复网络问题]
F --> H{服务器正常}
H --> |是| I[检查应用逻辑]
H --> |否| J[等待服务器恢复]
```

**Diagram sources **
- [multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L92-L112)
- [fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L99-L117)

## 测试方法
### 单元测试
编写单元测试验证代理配置的正确性。例如，测试不同代理类型的功能和故障转移机制。

### 集成测试
在实际环境中部署并测试代理配置，确保其在各种网络条件下稳定工作。

**Section sources**
- [unify-proxy.test.ts](file://lib/utils/proxy/unify-proxy.test.ts#L1-L142)
- [pac-proxy.test.ts](file://lib/utils/proxy/pac-proxy.test.ts#L1-L81)

## 结论
正确配置代理可以显著提升 RSSHub 的可用性和性能，尤其是在受限网络环境中。通过合理利用 PAC 脚本、多代理轮换和特定路由代理，可以实现灵活高效的网络访问策略。同时，应注意安全性和性能影响，确保系统的稳定运行。