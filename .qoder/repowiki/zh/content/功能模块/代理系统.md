# 代理系统

<cite>
**本文引用的文件**
- [lib/config.ts](file://lib/config.ts)
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts)
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts)
- [lib/utils/proxy/pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts)
- [lib/utils/request-rewriter/fetch.ts](file://lib/utils/request-rewriter/fetch.ts)
- [lib/utils/request-rewriter/get.ts](file://lib/utils/request-rewriter/get.ts)
- [lib/utils/request-rewriter/index.ts](file://lib/utils/request-rewriter/index.ts)
- [lib/middleware/cache.ts](file://lib/middleware/cache.ts)
- [lib/utils/cache/index.ts](file://lib/utils/cache/index.ts)
- [lib/utils/cache/memory.ts](file://lib/utils/cache/memory.ts)
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [组件详解](#组件详解)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录：配置示例与最佳实践](#附录配置示例与最佳实践)

## 简介
本文件面向RSSHub代理系统的使用者与维护者，系统性阐述代理配置的实现机制与运行流程，覆盖HTTP代理与SOCKS代理的配置方法、PAC代理与多代理（故障转移）策略、代理中间件在请求转发中的作用、连接池与调度器的使用、以及与缓存系统、安全控制系统的协同工作方式。同时提供不同网络环境下的配置示例与最佳实践，并讨论代理对性能的影响及优化建议。

## 项目结构
代理系统主要由以下模块构成：
- 配置层：集中定义代理相关的环境变量与默认值
- 代理适配层：统一解析与生成代理Agent与Dispatcher
- 请求重写层：拦截fetch与http/https请求，按策略注入代理
- 多代理与健康检查：轮询与故障转移
- PAC代理：基于脚本动态选择代理
- 中间件层：与缓存、安全控制等系统协作

```mermaid
graph TB
subgraph "配置层"
CFG["lib/config.ts"]
end
subgraph "代理适配层"
IDX["lib/utils/proxy/index.ts"]
UNI["lib/utils/proxy/unify-proxy.ts"]
MUL["lib/utils/proxy/multi-proxy.ts"]
PAC["lib/utils/proxy/pac-proxy.ts"]
end
subgraph "请求重写层"
RWF["lib/utils/request-rewriter/fetch.ts"]
RWG["lib/utils/request-rewriter/get.ts"]
RWI["lib/utils/request-rewriter/index.ts"]
end
subgraph "中间件层"
CACHE["lib/middleware/cache.ts"]
ACCESS["lib/middleware/access-control.ts"]
end
CFG --> IDX
IDX --> UNI
IDX --> MUL
IDX --> PAC
RWI --> RWF
RWI --> RWG
RWF --> IDX
RWG --> IDX
CACHE --> IDX
ACCESS --> IDX
```

图表来源
- [lib/config.ts](file://lib/config.ts#L747-L806)
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts#L1-L142)
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L1-L116)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L1-L141)
- [lib/utils/proxy/pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts#L1-L73)
- [lib/utils/request-rewriter/fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L1-L128)
- [lib/utils/request-rewriter/get.ts](file://lib/utils/request-rewriter/get.ts#L1-L93)
- [lib/utils/request-rewriter/index.ts](file://lib/utils/request-rewriter/index.ts#L1-L20)
- [lib/middleware/cache.ts](file://lib/middleware/cache.ts#L1-L84)
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts#L1-L27)

章节来源
- [lib/config.ts](file://lib/config.ts#L747-L806)
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts#L1-L142)
- [lib/utils/request-rewriter/index.ts](file://lib/utils/request-rewriter/index.ts#L1-L20)

## 核心组件
- 代理配置模型与环境变量
  - 支持单一代理URI或多个代理URI列表
  - 支持协议、主机、端口、认证、URL匹配正则、策略、故障转移超时、健康检查间隔、PAC URI/脚本
- 代理适配器
  - 统一解析PROXY_URI或PROXY_{PROTOCOL,HOST,PORT}组合
  - 生成Node.js Agent与Undici Dispatcher
  - 支持PAC代理与多代理（故障转移）
- 请求重写器
  - 拦截fetch与http/https请求，按策略注入代理
  - 基于URL正则与本地代理主机排除规则决定是否代理
- 多代理与健康检查
  - 轮询选择可用代理
  - 失败计数与阈值触发降级
  - 定时健康检查恢复
- 中间件集成
  - 与缓存中间件协作，避免并发重复请求
  - 与访问控制中间件协作，统一鉴权

章节来源
- [lib/config.ts](file://lib/config.ts#L274-L306)
- [lib/config.ts](file://lib/config.ts#L747-L806)
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L1-L116)
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts#L1-L142)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L1-L141)
- [lib/utils/proxy/pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts#L1-L73)
- [lib/utils/request-rewriter/fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L1-L128)
- [lib/utils/request-rewriter/get.ts](file://lib/utils/request-rewriter/get.ts#L1-L93)
- [lib/middleware/cache.ts](file://lib/middleware/cache.ts#L1-L84)
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts#L1-L27)

## 架构总览
代理系统采用“配置驱动 + 适配器 + 请求重写 + 多代理”的分层架构。请求从应用发起，经由请求重写器判断是否需要代理；若需要，则通过适配器生成Agent/Dispatcher并注入到请求中；多代理模块负责在多个代理之间进行轮询与故障转移；最终与缓存、安全控制等中间件协同工作。

```mermaid
sequenceDiagram
participant App as "应用"
participant Rewriter as "请求重写器(fetch)"
participant Proxy as "代理适配器"
participant Multi as "多代理/健康检查"
participant Target as "目标站点"
App->>Rewriter : 发起fetch请求
Rewriter->>Proxy : 计算是否需要代理(策略/正则/排除)
Proxy->>Multi : 获取当前代理(轮询/故障转移)
Multi-->>Proxy : 返回可用代理
Proxy-->>Rewriter : 返回Agent/Dispatcher
Rewriter->>Target : 使用代理发送请求
Target-->>Rewriter : 返回响应
Rewriter-->>App : 返回响应
```

图表来源
- [lib/utils/request-rewriter/fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L32-L127)
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts#L60-L141)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L69-L141)

## 组件详解

### 代理配置模型与环境变量
- 关键配置项
  - 单一代理：PROXY_URI
  - 多代理：PROXY_URIS（逗号分隔）、PROXY_STRATEGY（all/on_retry）
  - 代理参数：PROXY_PROTOCOL、PROXY_HOST、PROXY_PORT、PROXY_AUTH
  - 匹配规则：PROXY_URL_REGEX（默认全匹配）
  - 故障转移：PROXY_FAILOVER_TIMEOUT、PROXY_HEALTH_CHECK_INTERVAL
  - PAC：PAC_URI、PAC_SCRIPT
- 解析与默认值
  - 默认协议为http
  - 支持http/https/socks/socks4/socks4a/socks5/socks5h
  - 当PROXY_URI包含用户名密码时，优先使用URI内的凭据，忽略PROXY_AUTH
  - Puppeteer不支持HTTPS/SOCKS代理的认证字段，会给出警告

章节来源
- [lib/config.ts](file://lib/config.ts#L274-L306)
- [lib/config.ts](file://lib/config.ts#L747-L806)
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L1-L116)

### 代理适配器：统一解析与生成
- 统一入口
  - 支持PAC模式、多代理模式、单代理模式
  - 生成Node.js Agent（HttpsProxyAgent/PacProxyAgent/SocksProxyAgent）与Undici Dispatcher（ProxyAgent）
- PAC代理
  - 支持PAC_URI与PAC_SCRIPT（字符串形式），校验协议合法性
  - 与PROXY_AUTH兼容性处理
- 多代理
  - 将多个代理URI统一化后加入集合
  - 提供getNextProxy、markProxyFailed、resetProxy等能力
  - 健康检查定时器定期恢复被标记为不可用的代理

```mermaid
classDiagram
class ProxyAdapter {
+agent
+dispatcher
+proxyUri
+proxyObj
+proxyUrlHandler
+multiProxy
+getCurrentProxy()
+markProxyFailed(failedProxyUri)
+getAgentForProxy(state)
+getDispatcherForProxy(state)
}
class UnifyProxy {
+unifyProxy(proxyUri, proxyObj)
+unifyProxies(proxyUris, proxyObj)
}
class MultiProxy {
+allProxies
+getNextProxy()
+markProxyFailed(proxyUri)
+resetProxy(proxyUri)
}
class PacProxy {
+pacProxy(pacUri, pacScript, proxyObj)
}
ProxyAdapter --> UnifyProxy : "统一解析"
ProxyAdapter --> MultiProxy : "多代理"
ProxyAdapter --> PacProxy : "PAC代理"
```

图表来源
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts#L1-L142)
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L1-L116)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L1-L141)
- [lib/utils/proxy/pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts#L1-L73)

章节来源
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts#L1-L142)

### 请求重写器：代理注入与重试
- fetch重写
  - 在未显式指定dispatcher且满足策略条件时，根据URL正则与排除规则注入代理
  - 对多代理场景，失败时自动切换下一个代理，直至无可用代理则回退直连
- http/https重写
  - 在未显式指定agent且满足条件时，注入Node.js Agent
  - 同样遵循URL正则与排除规则
- 其他行为
  - 自动注入UA、Referer与随机头部
  - 速率限制队列保护

```mermaid
flowchart TD
Start(["请求进入"]) --> CheckStrategy["检查代理策略与URL正则"]
CheckStrategy --> NeedProxy{"需要代理？"}
NeedProxy --> |否| Direct["直接请求"]
NeedProxy --> |是| GetProxy["获取当前代理"]
GetProxy --> HasProxy{"有可用代理？"}
HasProxy --> |否| Fallback["回退直连"]
HasProxy --> |是| SendWithProxy["使用代理发送请求"]
SendWithProxy --> Resp{"成功？"}
Resp --> |是| Done(["返回响应"])
Resp --> |否| Multi{"多代理？"}
Multi --> |是| Switch["切换到下一个代理"] --> GetProxy
Multi --> |否| Fallback
```

图表来源
- [lib/utils/request-rewriter/fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L32-L127)
- [lib/utils/request-rewriter/get.ts](file://lib/utils/request-rewriter/get.ts#L1-L93)

章节来源
- [lib/utils/request-rewriter/fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L1-L128)
- [lib/utils/request-rewriter/get.ts](file://lib/utils/request-rewriter/get.ts#L1-L93)
- [lib/utils/request-rewriter/index.ts](file://lib/utils/request-rewriter/index.ts#L1-L20)

### 多代理与健康检查
- 选择策略
  - 轮询遍历所有活跃代理
  - 若当前代理不可用，自动跳过
- 失败判定
  - 连续失败达到阈值后标记为不可用
  - 设置最后失败时间
- 恢复机制
  - 定时器周期性检查，超过健康检查间隔后重置状态
- 手动重置
  - 提供resetProxy接口手动恢复

章节来源
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L1-L141)

### PAC代理
- 支持PAC_URI与PAC_SCRIPT两种方式
- 校验协议合法性（http/https/ftp/file/data）
- 与PROXY_AUTH兼容性处理，避免重复凭据

章节来源
- [lib/utils/proxy/pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts#L1-L73)

### 与缓存系统、安全控制系统的协同
- 与缓存中间件
  - 缓存命中时直接返回，避免代理开销
  - 并发请求去重，减少重复代理请求
- 与访问控制中间件
  - 在鉴权失败时快速拒绝，避免不必要的代理请求
- 与请求重写器
  - 仅在必要时注入代理，降低全局代理带来的额外开销

章节来源
- [lib/middleware/cache.ts](file://lib/middleware/cache.ts#L1-L84)
- [lib/utils/cache/index.ts](file://lib/utils/cache/index.ts#L1-L100)
- [lib/utils/cache/memory.ts](file://lib/utils/cache/memory.ts#L1-L44)
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts#L1-L27)

## 依赖关系分析
- 配置依赖
  - 代理配置来源于环境变量，统一映射到配置对象
- 代理适配器依赖
  - 依赖第三方库：https-proxy-agent、pac-proxy-agent、socks-proxy-agent、undici
  - 依赖统一解析与多代理模块
- 请求重写器依赖
  - 依赖代理适配器导出的Agent/Dispatcher
  - 依赖速率限制与头部生成工具
- 中间件依赖
  - 缓存中间件依赖全局缓存模块
  - 访问控制中间件依赖配置与哈希工具

```mermaid
graph LR
ENV["环境变量(PROXY_*, PAC_*)"] --> CFG["配置解析(lib/config.ts)"]
CFG --> ADP["代理适配器(lib/utils/proxy/index.ts)"]
ADP --> AGT["Agent/Dispatcher"]
ADP --> MUL["多代理(lib/utils/proxy/multi-proxy.ts)"]
ADP --> PAC["PAC代理(lib/utils/proxy/pac-proxy.ts)"]
ADP --> UNI["统一解析(lib/utils/proxy/unify-proxy.ts)"]
ADP --> RWF["请求重写(fetch)"]
ADP --> RWG["请求重写(get)"]
RWF --> NET["网络请求(undici)"]
RWG --> NET
CACHE["缓存中间件(lib/middleware/cache.ts)"] --> ADP
ACCESS["访问控制中间件(lib/middleware/access-control.ts)"] --> ADP
```

图表来源
- [lib/config.ts](file://lib/config.ts#L747-L806)
- [lib/utils/proxy/index.ts](file://lib/utils/proxy/index.ts#L1-L142)
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L1-L116)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L1-L141)
- [lib/utils/proxy/pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts#L1-L73)
- [lib/utils/request-rewriter/fetch.ts](file://lib/utils/request-rewriter/fetch.ts#L1-L128)
- [lib/utils/request-rewriter/get.ts](file://lib/utils/request-rewriter/get.ts#L1-L93)
- [lib/middleware/cache.ts](file://lib/middleware/cache.ts#L1-L84)
- [lib/middleware/access-control.ts](file://lib/middleware/access-control.ts#L1-L27)

## 性能考量
- 代理注入策略
  - 使用PROXY_STRATEGY=all可全局代理，但可能增加延迟与失败概率
  - 使用on_retry策略仅在重试时代理，减少不必要的代理开销
- URL正则与排除规则
  - 合理设置PROXY_URL_REGEX，避免对内网或本地地址代理
  - 排除本地回环与Puppeteer WS端点，防止错误代理
- 多代理与健康检查
  - 合理设置PROXY_HEALTH_CHECK_INTERVAL，平衡恢复速度与CPU消耗
  - 控制maxFailures阈值，避免频繁切换导致抖动
- 连接池与调度器
  - Undici的ProxyAgent具备连接复用能力，减少握手开销
  - 与速率限制配合，避免瞬时洪峰
- 缓存与并发
  - 缓存中间件减少重复请求，间接降低代理压力
  - 并发去重避免重复抓取同一路径

[本节为通用指导，无需列出具体文件来源]

## 故障排查指南
- 代理未生效
  - 检查PROXY_URI/PROXY_{PROTOCOL,HOST,PORT}是否正确配置
  - 确认URL正则匹配与排除规则是否覆盖目标域名
  - 查看日志中关于代理协议与认证的提示
- 代理认证问题
  - HTTPS/SOCKS代理的认证不适用于Puppeteer，需使用HTTP代理或调整策略
- 多代理全部失效
  - 检查健康检查间隔与失败阈值
  - 使用resetProxy手动恢复特定代理
- 请求超时或失败
  - 调整PROXY_FAILOVER_TIMEOUT与PROXY_HEALTH_CHECK_INTERVAL
  - 适当放宽重试次数与请求超时
- 缓存与代理冲突
  - 确认缓存中间件已启用且未对目标路径禁用
  - 检查并发去重逻辑是否导致请求阻塞

章节来源
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L1-L116)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L1-L141)
- [lib/middleware/cache.ts](file://lib/middleware/cache.ts#L1-L84)

## 结论
RSSHub代理系统以配置为中心，通过统一解析、适配器与多代理机制，实现了灵活、可扩展的代理能力。结合请求重写器与中间件，系统在保证稳定性的同时兼顾性能与可维护性。合理配置代理策略、URL正则与健康检查参数，可在复杂网络环境中获得更佳的可用性与吞吐表现。

[本节为总结性内容，无需列出具体文件来源]

## 附录：配置示例与最佳实践

- 环境变量清单（节选）
  - PROXY_URI：单一代理URI（含协议、主机、端口、可选认证）
  - PROXY_URIS：多个代理URI（逗号分隔）
  - PROXY_PROTOCOL/PROXY_HOST/PROXY_PORT/PROXY_AUTH：分别配置协议、主机、端口与认证
  - PROXY_URL_REGEX：代理匹配正则，默认全匹配
  - PROXY_STRATEGY：all 或 on_retry
  - PROXY_FAILOVER_TIMEOUT：故障转移超时
  - PROXY_HEALTH_CHECK_INTERVAL：健康检查间隔
  - PAC_URI/PAC_SCRIPT：PAC代理配置
- 配置示例（说明性）
  - 单一HTTP代理：设置PROXY_URI为http://host:port或http://user:pass@host:port
  - 多代理故障转移：设置PROXY_URIS为多个URI，策略选择all或on_retry
  - PAC代理：设置PAC_URI为支持的协议（http/https/ftp/file/data），或PAC_SCRIPT为脚本字符串
  - URL过滤：设置PROXY_URL_REGEX为白名单正则，避免对内网/本地地址代理
- 最佳实践
  - 生产环境优先使用多代理与on_retry策略，提升容错能力
  - 合理设置健康检查与失败阈值，避免频繁切换
  - 与缓存中间件配合，减少重复请求与代理压力
  - 对Puppeteer场景避免使用HTTPS/SOCKS代理的认证字段

章节来源
- [lib/config.ts](file://lib/config.ts#L274-L306)
- [lib/config.ts](file://lib/config.ts#L747-L806)
- [lib/utils/proxy/unify-proxy.ts](file://lib/utils/proxy/unify-proxy.ts#L1-L116)
- [lib/utils/proxy/multi-proxy.ts](file://lib/utils/proxy/multi-proxy.ts#L1-L141)
- [lib/utils/proxy/pac-proxy.ts](file://lib/utils/proxy/pac-proxy.ts#L1-L73)
- [lib/middleware/cache.ts](file://lib/middleware/cache.ts#L1-L84)