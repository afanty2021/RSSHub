# 爱奇艺内容聚合

<cite>
**本文档引用文件**   
- [album.ts](file://lib/routes/iqiyi/album.ts)
- [video.ts](file://lib/routes/iqiyi/video.ts)
- [namespace.ts](file://lib/routes/iqiyi/namespace.ts)
- [album.art](file://lib/routes/iqiyi/templates/album.art)
- [parse-date.ts](file://lib/utils/parse-date.ts)
- [got.ts](file://lib/utils/got.ts)
- [cache.ts](file://lib/middleware/cache.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细说明了爱奇艺内容聚合API的实现机制，涵盖电视剧、电影、综艺等内容的聚合技术。文档解释了视频元数据提取、播放列表处理、更新信息获取和推荐内容抓取的技术实现，为开发者提供全面的指导。

## 项目结构
爱奇艺内容聚合功能位于`lib/routes/iqiyi`目录下，包含剧集和用户视频的路由实现。项目采用模块化设计，分离了数据抓取、缓存管理和模板渲染等职责。

```mermaid
graph TB
subgraph "爱奇艺内容聚合"
A[album.ts] --> B[剧集内容聚合]
C[video.ts] --> D[用户视频聚合]
E[namespace.ts] --> F[命名空间定义]
G[templates/album.art] --> H[模板渲染]
end
```

**图示来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L1-L88)
- [video.ts](file://lib/routes/iqiyi/video.ts#L1-L77)
- [namespace.ts](file://lib/routes/iqiyi/namespace.ts#L1-L8)
- [album.art](file://lib/routes/iqiyi/templates/album.art#L1-L2)

**本节来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L1-L88)
- [video.ts](file://lib/routes/iqiyi/video.ts#L1-L77)

## 核心组件
爱奇艺内容聚合的核心组件包括剧集聚合模块和用户视频聚合模块。剧集聚合模块通过API接口获取视频专辑信息和剧集列表，用户视频聚合模块使用Puppeteer抓取用户上传的视频内容。

**本节来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L1-L88)
- [video.ts](file://lib/routes/iqiyi/video.ts#L1-L77)

## 架构概述
爱奇艺内容聚合系统采用分层架构，包括路由层、数据抓取层、缓存层和渲染层。系统通过定义清晰的接口和职责分离，实现了高效的内容聚合。

```mermaid
graph TD
A[客户端请求] --> B[路由分发]
B --> C{请求类型}
C --> |剧集| D[API数据抓取]
C --> |用户视频| E[Puppeteer页面抓取]
D --> F[缓存管理]
E --> F
F --> G[数据处理]
G --> H[模板渲染]
H --> I[响应返回]
```

**图示来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L1-L88)
- [video.ts](file://lib/routes/iqiyi/video.ts#L1-L77)
- [got.ts](file://lib/utils/got.ts#L1-L90)
- [cache.ts](file://lib/middleware/cache.ts#L1-L100)

## 详细组件分析

### 剧集聚合分析
剧集聚合功能通过调用爱奇艺的API接口获取专辑信息和剧集列表。系统首先获取专辑基本信息，然后分页获取所有剧集信息，最后整合数据生成RSS输出。

```mermaid
sequenceDiagram
participant 客户端
participant 路由
participant API抓取
participant 缓存
participant 渲染
客户端->>路由 : 请求 /iqiyi/album/ : id
路由->>API抓取 : 获取专辑基本信息
API抓取->>API抓取 : 循环获取剧集列表
API抓取->>缓存 : 存储聚合数据
缓存->>渲染 : 获取数据
渲染->>客户端 : 返回RSS响应
```

**图示来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L32-L87)
- [got.ts](file://lib/utils/got.ts#L1-L90)
- [cache.ts](file://lib/middleware/cache.ts#L1-L100)

**本节来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L1-L88)

### 用户视频聚合分析
用户视频聚合功能使用Puppeteer浏览器自动化工具抓取用户页面内容。由于爱奇艺用户页面存在加载延迟，系统需要等待特定元素出现后才能提取数据。

```mermaid
flowchart TD
Start([开始]) --> 初始化["初始化Puppeteer浏览器"]
初始化 --> 设置拦截["设置请求拦截"]
设置拦截 --> 导航["导航到用户视频页面"]
导航 --> 等待元素["等待li.pic-txt-li元素"]
等待元素 --> 获取内容["获取页面HTML内容"]
获取内容 --> 解析["使用Cheerio解析内容"]
解析 --> 提取["提取视频信息"]
提取 --> 返回["返回RSS数据"]
返回 --> End([结束])
```

**图示来源**
- [video.ts](file://lib/routes/iqiyi/video.ts#L35-L76)
- [puppeteer](file://lib/utils/puppeteer.ts#L1-L50)
- [cheerio](file://lib/utils/cheerio.ts#L1-L30)

**本节来源**
- [video.ts](file://lib/routes/iqiyi/video.ts#L1-L77)

## 依赖分析
爱奇艺内容聚合功能依赖多个核心工具和库，包括HTTP客户端、缓存系统、日期解析和模板渲染等。

```mermaid
graph LR
A[iqiyi模块] --> B[got]
A --> C[cache]
A --> D[parseDate]
A --> E[art]
A --> F[cheerio]
B --> G[HTTP请求]
C --> H[数据缓存]
D --> I[日期解析]
E --> J[模板渲染]
F --> K[HTML解析]
```

**图示来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L1-L88)
- [video.ts](file://lib/routes/iqiyi/video.ts#L1-L77)
- [got.ts](file://lib/utils/got.ts#L1-L90)
- [parse-date.ts](file://lib/utils/parse-date.ts#L1-L208)

**本节来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L1-L88)
- [video.ts](file://lib/routes/iqiyi/video.ts#L1-L77)
- [got.ts](file://lib/utils/got.ts#L1-L90)
- [parse-date.ts](file://lib/utils/parse-date.ts#L1-L208)

## 性能考虑
爱奇艺内容聚合系统通过缓存机制优化性能，减少对爱奇艺API的重复请求。剧集聚合使用分页加载避免一次性获取过多数据，用户视频聚合通过请求拦截减少不必要的资源加载。

**本节来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L49-L68)
- [video.ts](file://lib/routes/iqiyi/video.ts#L41-L72)
- [cache.ts](file://lib/middleware/cache.ts#L1-L100)

## 故障排除指南
常见问题包括地区限制导致的内容不可用、API接口变更导致的数据抓取失败和Puppeteer执行超时等。系统通过错误处理机制提供清晰的错误信息。

**本节来源**
- [album.ts](file://lib/routes/iqiyi/album.ts#L45-L47)
- [video.ts](file://lib/routes/iqiyi/video.ts#L49-L53)
- [errors.ts](file://lib/errors/types/invalid-parameter.ts#L1-L20)

## 结论
爱奇艺内容聚合API提供了高效的内容抓取和聚合功能，支持剧集和用户视频两种内容类型。系统通过合理的架构设计和性能优化，为开发者提供了稳定可靠的内容聚合服务。