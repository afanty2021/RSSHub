# 缓存监控

<cite>
**本文档引用的文件**
- [cache.ts](file://lib/middleware/cache.ts)
- [config.ts](file://lib/config.ts)
- [memory.ts](file://lib/utils/cache/memory.ts)
- [redis.ts](file://lib/utils/cache/redis.ts)
- [index.ts](file://lib/utils/cache/index.ts)
- [debug-info.ts](file://lib/utils/debug-info.ts)
- [metric.ts](file://lib/utils/otel/metric.ts)
- [debug.ts](file://lib/middleware/debug.ts)
</cite>

## 目录
1. [简介](#简介)
2. [缓存监控指标](#缓存监控指标)
3. [内置缓存统计功能](#内置缓存统计功能)
4. [Prometheus监控集成](#prometheus监控集成)
5. [性能分析与优化](#性能分析与优化)
6. [告警设置](#告警设置)

## 简介
RSSHub项目提供了完善的缓存监控机制，通过多种方式监控缓存命中率、缓存大小和内存使用情况。系统支持内存缓存和Redis缓存两种模式，并提供了详细的统计指标和监控集成能力。本文档详细说明如何监控缓存性能，获取关键指标，并与外部监控工具集成。

**Section sources**
- [cache.ts](file://lib/middleware/cache.ts#L1-L84)
- [config.ts](file://lib/config.ts#L23-L28)

## 缓存监控指标
RSSHub缓存系统提供了多个关键监控指标，用于评估缓存性能和效率。

### 缓存命中率
缓存命中率是衡量缓存效率的核心指标，计算公式为：缓存命中次数 / 总请求次数。RSSHub通过中间件自动统计缓存命中情况，并在响应头中添加`RSSHub-Cache-Status`字段标识缓存状态（HIT表示命中，MISS表示未命中）。

### 缓存大小与内存使用
系统监控缓存的大小和内存使用情况，具体指标包括：
- **缓存项数量**：当前缓存中存储的键值对数量
- **内存占用**：缓存占用的内存大小
- **最大内存限制**：通过`MEMORY_MAX`环境变量配置的最大内存使用量

### 平均响应时间
系统记录请求的响应时间，用于分析缓存对性能的提升效果。缓存命中的请求通常具有更短的响应时间。

**Section sources**
- [cache.ts](file://lib/middleware/cache.ts#L48-L54)
- [debug-info.ts](file://lib/utils/debug-info.ts#L2-L3)

## 内置缓存统计功能
RSSHub提供了内置的缓存统计功能，可以获取缓存命中/未命中计数、请求频率等关键指标。

### 缓存命中/未命中计数
系统通过`debug-info.ts`文件中的`DebugInfo`对象统计缓存命中情况：
```typescript
type DebugInfo = {
    hitCache: number;    // 缓存命中次数
    request: number;     // 总请求次数
    etag: number;        // ETag匹配次数
    error: number;       // 错误次数
};
```

### 统计数据获取
通过`getDebugInfo()`函数可以获取当前的调试信息，包括缓存命中率、请求频率等指标。这些数据在系统首页的调试信息面板中展示。

### 缓存键生成
系统使用XXH64哈希算法生成缓存键，确保键的唯一性和紧凑性。缓存键的生成考虑了请求路径、格式和限制参数：
```typescript
const key = 'rsshub:koa-redis-cache:' + h64ToString(requestPath + format + limit);
```

**Section sources**
- [debug-info.ts](file://lib/utils/debug-info.ts#L1-L24)
- [cache.ts](file://lib/middleware/cache.ts#L22-L23)
- [debug.ts](file://lib/middleware/debug.ts#L29-L31)

## Prometheus监控集成
RSSHub集成了OpenTelemetry和Prometheus，支持将缓存指标导出到外部监控系统。

### 指标导出配置
系统通过`metric.ts`文件配置Prometheus指标导出：
```typescript
const exporter = new PrometheusExporter({});
const provider = new MeterProvider({
    resource: resourceFromAttributes({
        [ATTR_SERVICE_NAME]: 'rsshub',
    }),
    readers: [exporter],
});
```

### 关键监控指标
导出的关键指标包括：
- `rsshub_request_total`：总请求数
- `rsshub_request_error_total`：错误请求数
- `rsshub_request_duration_seconds_bucket`：请求持续时间（秒）
- `rsshub_request_duration_milliseconds_bucket`：请求持续时间（毫秒）

### 指标获取
通过`getContext()`函数可以获取当前的监控上下文，返回Prometheus格式的指标数据：
```typescript
export const getContext = () =>
    new Promise<string>((resolve, reject) => {
        exporter
            .collect()
            .then((value) => {
                resolve(serializer.serialize(value.resourceMetrics));
            })
            .finally(() => {
                reject('');
            });
    });
```

**Section sources**
- [metric.ts](file://lib/utils/otel/metric.ts#L1-L69)
- [config.ts](file://lib/config.ts#L48-L49)

## 性能分析与优化
通过分析缓存指标，可以识别缓存效率问题并进行优化。

### 缓存效率分析
监控以下指标可以帮助识别性能问题：
- **低缓存命中率**：如果命中率持续低于预期，可能需要调整缓存策略或增加缓存容量
- **高内存使用**：如果内存使用接近上限，可能需要优化缓存项大小或增加内存限制
- **长响应时间**：即使缓存命中，如果响应时间仍然较长，可能需要分析后端服务性能

### 缓存策略优化
根据监控数据调整缓存配置：
- **调整缓存过期时间**：根据内容更新频率调整`CACHE_EXPIRE`和`CACHE_CONTENT_EXPIRE`
- **优化缓存大小**：根据内存使用情况调整`MEMORY_MAX`值
- **选择合适的缓存类型**：根据部署环境选择'memory'或'redis'缓存类型

### 并发请求处理
系统通过控制键（controlKey）处理并发请求，避免重复请求后端服务：
```typescript
const controlKey = 'rsshub:path-requested:' + h64ToString(requestPath + format + limit);
```

**Section sources**
- [cache.ts](file://lib/middleware/cache.ts#L24-L44)
- [config.ts](file://lib/config.ts#L25-L27)

## 告警设置
基于监控指标设置告警规则，及时发现和处理缓存问题。

### 告警指标
建议监控以下指标并设置告警：
- **缓存命中率低于阈值**：例如低于80%
- **缓存内存使用超过阈值**：例如超过80%
- **请求错误率上升**：例如错误率超过5%
- **响应时间异常**：例如P95响应时间超过1秒

### 告警配置
在Prometheus中配置告警规则，例如：
```yaml
- alert: LowCacheHitRatio
  expr: rate(rsshub_request_total{status="HIT"}[5m]) / rate(rsshub_request_total[5m]) < 0.8
  for: 10m
  labels:
    severity: warning
  annotations:
    summary: "缓存命中率过低"
    description: "缓存命中率持续低于80%，当前值为{{ $value }}"

- alert: HighMemoryUsage
  expr: go_memstats_alloc_bytes / go_memstats_sys_bytes > 0.8
  for: 10m
  labels:
    severity: warning
  annotations:
    summary: "内存使用过高"
    description: "内存使用率持续超过80%，当前值为{{ $value }}"
```

**Section sources**
- [metric.ts](file://lib/utils/otel/metric.ts#L34-L45)
- [config.ts](file://lib/config.ts#L23-L28)