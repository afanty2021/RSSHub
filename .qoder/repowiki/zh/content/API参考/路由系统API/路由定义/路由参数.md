# 路由参数

<cite>
**本文档引用的文件**
- [parameter.ts](file://lib/middleware/parameter.ts)
- [parameter.test.ts](file://lib/middleware/parameter.test.ts)
- [types.ts](file://lib/types.ts)
- [router.js](file://lib/router.js)
- [json.ts](file://lib/routes/rsshub/transform/json.ts)
- [html.ts](file://lib/routes/rsshub/transform/html.ts)
- [helpers.ts](file://lib/utils/helpers.ts)
- [readable-social.ts](file://lib/utils/readable-social.ts)
- [invalid-parameter.ts](file://lib/errors/types/invalid-parameter.ts)
</cite>

## 目录
1. [引言](#引言)
2. [路由参数类型](#路由参数类型)
3. [参数定义与语法](#参数定义与语法)
4. [参数验证与错误处理](#参数验证与错误处理)
5. [参数解析与访问](#参数解析与访问)
6. [参数命名规范与最佳实践](#参数命名规范与最佳实践)
7. [常见问题解决方案](#常见问题解决方案)
8. [结论](#结论)

## 引言

RSSHub 是一个开源的 RSS 生成器，它通过定义路由和参数来抓取和转换网页内容为 RSS 格式。路由参数在 RSSHub 中扮演着至关重要的角色，它们允许用户自定义请求，从而获取特定的内容。本文档将深入探讨 RSSHub 中路由参数的各个方面，包括静态路径、动态参数和查询参数的定义方式和使用语法，以及参数验证、错误处理、解析过程和访问方式。此外，我们还将讨论参数命名规范和最佳实践，以及常见参数相关问题的解决方案。

## 路由参数类型

在 RSSHub 中，路由参数主要分为三种类型：静态路径、动态参数和查询参数。每种类型的参数都有其特定的用途和定义方式。

### 静态路径

静态路径是路由定义中固定不变的部分，用于标识特定的资源或服务。例如，在路由 `/benedictevans` 中，`/benedictevans` 就是一个静态路径，它指向 Benedict Evans 的最新文章。静态路径通常用于定义基本的路由结构，不包含任何变量或通配符。

### 动态参数

动态参数是路由定义中可变的部分，通常用冒号 `:` 后跟参数名来表示。这些参数允许用户在请求时提供具体的值，从而获取不同的内容。例如，在路由 `/disqus/posts/:forum` 中，`:forum` 是一个动态参数，用户可以通过替换 `:forum` 的值来获取不同论坛的帖子。

### 查询参数

查询参数是附加在 URL 末尾的键值对，用于进一步定制请求。它们以问号 `?` 开头，多个参数之间用与号 `&` 分隔。查询参数可以用于过滤、排序、限制结果数量等操作。例如，在请求 `/test/1?filter=Description4|Title5&limit=3` 中，`filter` 和 `limit` 都是查询参数，分别用于过滤内容和限制返回的结果数量。

## 参数定义与语法

在 RSSHub 中，参数的定义和使用遵循一定的语法规范。了解这些规范对于正确配置和使用路由至关重要。

### 动态参数语法

动态参数在路由定义中使用冒号 `:` 后跟参数名的形式。参数名可以包含字母、数字和下划线，但不能以数字开头。例如：

```javascript
router.get('/disqus/posts/:forum', lazyloadRouteHandler('./routes/disqus/posts'));
```

在这个例子中，`:forum` 是一个动态参数，用户可以在请求时提供具体的论坛名称，如 `/disqus/posts/tech`。

### 查询参数语法

查询参数以问号 `?` 开头，后跟一个或多个键值对，键值对之间用与号 `&` 分隔。每个键值对由键和值组成，键和值之间用等号 `=` 分隔。例如：

```javascript
/test/1?filter=Description4|Title5&limit=3
```

在这个例子中，`filter` 和 `limit` 是两个查询参数，`filter` 的值是 `Description4|Title5`，`limit` 的值是 `3`。

### 参数组合

在实际应用中，动态参数和查询参数可以结合使用，以实现更复杂的请求定制。例如：

```javascript
router.get('/github/repos/:owner/:repo/releases', lazyloadRouteHandler('./routes/github/releases'));
```

在这个例子中，`:owner` 和 `:repo` 是动态参数，用户可以通过提供具体的拥有者和仓库名称来获取特定仓库的发布信息。同时，用户还可以通过添加查询参数来进一步定制请求，如 `/github/repos/DIYgod/RSSHub/releases?filter=bugfix&limit=5`。

## 参数验证与错误处理

参数验证是确保请求合法性和安全性的关键步骤。RSSHub 提供了多种机制来验证和处理参数，以防止无效或恶意请求。

### 参数验证机制

RSSHub 使用中间件来处理参数验证。例如，`parameter.ts` 文件中的中间件负责处理各种查询参数，如 `filter`、`limit` 和 `sorted`。这些中间件会检查参数的有效性，并根据需要进行相应的处理。

```typescript
const makeRegex = (str: string) => {
    const insensitive = ctx.req.query('filter_case_sensitive') === 'false';
    switch (engine) {
        case 'regexp':
            return new RegExp(str, insensitive ? 'i' : '');
        case 're2':
            return RE2JS.compile(str, insensitive ? RE2JS.CASE_INSENSITIVE : 0);
        default:
            throw new Error(`Invalid Engine Value: ${engine}, please check your config.`);
    }
};
```

这段代码展示了如何根据配置选择正则表达式引擎，并创建相应的正则表达式对象。如果配置的引擎值无效，会抛出一个错误。

### 错误处理策略

当参数验证失败时，RSSHub 会抛出相应的错误，并返回适当的 HTTP 状态码和错误消息。例如，如果用户提供的 `limit` 参数不是有效的整数，系统会抛出一个错误并返回 400 状态码。

```typescript
if (ctx.req.query('brief')) {
    const num = /[1-9]\d{2,}/;
    if (num.test(ctx.req.query('brief')!)) {
        const brief: number = Number.parseInt(ctx.req.query('brief')!);
        // 处理 brief 参数
    } else {
        throw new Error(`Invalid parameter brief. Please check the doc https://docs.rsshub.app/guide/parameters#shu-chu-jian-xun`);
    }
}
```

在这段代码中，如果 `brief` 参数不符合预期的格式，会抛出一个错误，并提示用户查阅文档以获取更多信息。

## 参数解析与访问

在 RSSHub 中，参数的解析和访问是通过上下文对象 `ctx` 来完成的。`ctx` 对象提供了多种方法来获取和处理参数。

### 动态参数的访问

动态参数可以通过 `ctx.req.param()` 方法来访问。例如，在处理 `/disqus/posts/:forum` 路由时，可以通过 `ctx.req.param('forum')` 获取 `:forum` 参数的值。

```typescript
async function handler(ctx) {
    const forum = ctx.req.param('forum');
    // 使用 forum 参数进行后续处理
}
```

### 查询参数的访问

查询参数可以通过 `ctx.req.query()` 方法来访问。例如，在处理 `/test/1?filter=Description4|Title5&limit=3` 请求时，可以通过 `ctx.req.query('filter')` 和 `ctx.req.query('limit')` 分别获取 `filter` 和 `limit` 参数的值。

```typescript
async function handler(ctx) {
    const filter = ctx.req.query('filter');
    const limit = ctx.req.query('limit');
    // 使用 filter 和 limit 参数进行后续处理
}
```

### 参数解析示例

以下是一个完整的参数解析示例，展示了如何在处理函数中使用动态参数和查询参数：

```typescript
async function handler(ctx) {
    const url = ctx.req.param('url');
    const response = await got({
        method: 'get',
        url,
    });

    const routeParams = new URLSearchParams(ctx.req.param('routeParams'));
    let rssTitle = routeParams.get('title');
    if (!rssTitle) {
        const resp = await got({
            method: 'get',
            url: new URL(url).origin,
        });
        const $ = load(resp.data);
        rssTitle = $('title').text();
    }

    // 使用 rssTitle 和其他参数进行后续处理
}
```

在这个示例中，`url` 是一个动态参数，`routeParams` 是一个包含多个查询参数的字符串。通过 `new URLSearchParams()` 方法，可以将 `routeParams` 字符串解析为一个 `URLSearchParams` 对象，然后使用 `get()` 方法获取各个参数的值。

## 参数命名规范与最佳实践

为了确保代码的可读性和维护性，遵循一定的参数命名规范和最佳实践是非常重要的。

### 命名规范

- **清晰明了**：参数名应尽可能清晰地描述其用途，避免使用模糊或容易引起误解的名称。
- **小写连字符**：建议使用小写字母和连字符（`-`）来分隔单词，如 `filter-case-sensitive`。
- **避免缩写**：除非非常常见且不会引起混淆，否则应避免使用缩写，以提高代码的可读性。

### 最佳实践

- **默认值**：为可选参数提供合理的默认值，以减少用户的配置负担。
- **文档化**：在路由定义中添加详细的注释，说明每个参数的用途、类型和可能的值。
- **验证**：对所有输入参数进行严格的验证，确保它们符合预期的格式和范围。
- **安全性**：避免直接使用用户提供的参数值，特别是在构建 SQL 查询或执行外部命令时，以防止注入攻击。

## 常见问题解决方案

在使用 RSSHub 的路由参数时，可能会遇到一些常见问题。以下是几个典型问题及其解决方案。

### 问题1：参数值无效

**症状**：请求返回 400 状态码，提示参数无效。

**解决方案**：检查参数值是否符合预期的格式和范围。例如，如果 `limit` 参数期望一个正整数，确保提供的值是一个有效的正整数。

### 问题2：参数未正确解析

**症状**：请求返回 500 状态码，提示内部服务器错误。

**解决方案**：检查参数解析逻辑，确保所有必要的参数都被正确解析和处理。例如，确保 `URLSearchParams` 对象正确地解析了查询参数字符串。

### 问题3：性能问题

**症状**：请求响应时间过长，影响用户体验。

**解决方案**：优化参数处理逻辑，减少不必要的计算和网络请求。例如，使用缓存来存储频繁访问的数据，减少重复的数据库查询。

## 结论

RSSHub 的路由参数系统为用户提供了强大的灵活性和定制能力。通过合理使用静态路径、动态参数和查询参数，用户可以轻松地获取所需的内容。同时，通过严格的参数验证和错误处理机制，RSSHub 确保了请求的安全性和可靠性。遵循良好的命名规范和最佳实践，可以进一步提高代码的可读性和维护性。希望本文档能帮助开发者更好地理解和使用 RSSHub 的路由参数功能。

**Section sources**
- [parameter.ts](file://lib/middleware/parameter.ts)
- [parameter.test.ts](file://lib/middleware/parameter.test.ts)
- [types.ts](file://lib/types.ts)
- [router.js](file://lib/router.js)
- [json.ts](file://lib/routes/rsshub/transform/json.ts)
- [html.ts](file://lib/routes/rsshub/transform/html.ts)
- [helpers.ts](file://lib/utils/helpers.ts)
- [readable-social.ts](file://lib/utils/readable-social.ts)
- [invalid-parameter.ts](file://lib/errors/types/invalid-parameter.ts)