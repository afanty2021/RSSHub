# 路由定义

<cite>
**本文档中引用的文件**  
- [router.js](file://lib/router.js)
- [registry.ts](file://lib/registry.ts)
- [types.ts](file://lib/types.ts)
- [dgtle/article.ts](file://lib/routes/dgtle/article.ts)
- [voronoiapp/search.ts](file://lib/routes/voronoiapp/search.ts)
- [hitsz/due.ts](file://lib/routes/hitsz/due.ts)
- [voronoiapp/common.ts](file://lib/routes/voronoiapp/common.ts)
</cite>

## 目录
1. [引言](#引言)
2. [路由文件组织结构与命名规范](#路由文件组织结构与命名规范)
3. [路由导出格式与必需属性](#路由导出格式与必需属性)
4. [路径定义：静态、动态与通配符](#路径定义静态动态与通配符)
5. [处理函数与上下文](#处理函数与上下文)
6. [路由配置项详解](#路由配置项详解)
7. [雷达规则（Radar Rules）](#雷达规则radar-rules)
8. [最佳实践与常见错误规避](#最佳实践与常见错误规避)
9. [总结](#总结)

## 引言

RSSHub 是一个基于 Node.js 的轻量级 RSS 生成器，其核心功能之一是通过灵活的路由系统将各种网页内容转换为 RSS 订阅源。本文档深入解析 RSSHub 中如何定义和注册路由，涵盖路由文件的组织结构、命名规范、导出格式、路径语法、处理函数、配置项以及最佳实践。通过本指南，开发者可以全面理解 RSSHub 的路由机制，并正确实现新的 RSS 订阅源。

## 路由文件组织结构与命名规范

RSSHub 的路由文件统一存放在 `lib/routes/` 目录下，采用模块化组织方式。每个网站或服务通常对应一个独立的子目录，目录名一般为该服务的标识符（如 `dgtle`、`voronoiapp`、`hitsz` 等）。在该子目录中，可以包含多个 `.ts` 文件，每个文件定义一个或多个相关的路由。

例如：
- `lib/routes/dgtle/article.ts`：定义数字尾巴网站的文章相关路由。
- `lib/routes/voronoiapp/search.ts`：定义 Voronoi App 的搜索功能路由。
- `lib/routes/hitsz/due.ts`：定义哈尔滨工业大学（深圳）教务部的公告路由。

这种结构清晰地分离了不同来源的路由逻辑，便于维护和扩展。文件命名应具有描述性，反映其功能，如 `search.ts`、`common.ts`（存放共享逻辑）等。

**Section sources**
- [dgtle/article.ts](file://lib/routes/dgtle/article.ts)
- [voronoiapp/search.ts](file://lib/routes/voronoiapp/search.ts)
- [hitsz/due.ts](file://lib/routes/hitsz/due.ts)

## 路由导出格式与必需属性

在 RSSHub 中，路由通过 `export const route: Route` 的方式定义和导出。`Route` 是一个 TypeScript 接口，定义了路由必须包含的属性。以下是 `Route` 接口的关键属性：

- **path**: 路由路径，支持字符串或字符串数组，使用 Hono 的路由语法。
- **name**: 路由的可读名称，用于文档生成。
- **maintainers**: 维护者 GitHub 用户名列表。
- **handler**: 处理函数，接收 `Context` 对象并返回 `Data` 或 `Response`。
- **example**: 路由的示例 URL。
- **parameters**: 路径参数的描述，用于文档生成。

一个典型的路由导出如下：
```typescript
export const route: Route = {
    path: '/article/:id?/:pushed?',
    name: '文章',
    maintainers: ['nczitzk'],
    handler,
    example: '/dgtle/article/0/0',
    parameters: { /* ... */ },
    // 其他属性
};
```

**Section sources**
- [types.ts](file://lib/types.ts#L259-L370)
- [dgtle/article.ts](file://lib/routes/dgtle/article.ts#L45-L334)

## 路径定义：静态、动态与通配符

RSSHub 使用 Hono 的路由匹配语法，支持多种路径模式：

### 静态路径
最简单的路径形式，匹配固定的 URL。
```typescript
path: '/benedictevans'
```
此路径匹配 `/benedictevans`。

### 动态参数
使用冒号 `:` 定义动态参数，匹配任意值。
```typescript
path: '/disqus/posts/:forum'
```
此路径匹配 `/disqus/posts/abc`，其中 `abc` 作为 `forum` 参数的值，可通过 `ctx.req.param('forum')` 获取。

### 可选参数
在参数后加 `?` 表示该参数是可选的。
```typescript
path: '/article/:id?/:pushed?'
```
此路径可匹配 `/article`、`/article/0` 或 `/article/0/1`。

### 通配符
使用 `*` 可以匹配任意路径。
```typescript
path: '/cqu/jwc/:path*'
```
此路径匹配 `/cqu/jwc/` 后接任意子路径。

**Section sources**
- [router.js](file://lib/router.js#L24-L158)
- [types.ts](file://lib/types.ts#L263)
- [dgtle/article.ts](file://lib/routes/dgtle/article.ts#L46)

## 处理函数与上下文

处理函数是路由的核心，负责获取数据、解析内容并生成 RSS 格式的响应。它接收一个 `Context` 对象作为参数，该对象封装了 HTTP 请求和响应。

处理函数通常执行以下步骤：
1. 从 `ctx.req.param()` 中提取路径参数。
2. 从 `ctx.req.query()` 中提取查询参数。
3. 使用 `ofetch` 或 `got` 等工具发起 HTTP 请求获取目标网页内容。
4. 使用 `cheerio` 等库解析 HTML，提取所需数据。
5. 构造并返回一个符合 `Data` 接口的对象。

```typescript
handler: async (ctx) => {
    const { keyword } = ctx.req.param();
    const items = await getPostItems({ search: keyword });
    return {
        title: `Voronoi Posts for "${keyword}"`,
        link: `https://www.voronoiapp.com/explore?search=${encodeURIComponent(keyword)}`,
        item: items,
    } as Data;
}
```

**Section sources**
- [voronoiapp/search.ts](file://lib/routes/voronoiapp/search.ts#L24-L33)
- [dgtle/article.ts](file://lib/routes/dgtle/article.ts#L11-L43)
- [types.ts](file://lib/types.ts#L284)

## 路由配置项详解

除了基本属性外，`Route` 接口还包含多个配置项，用于描述路由的特性和行为。

### features
`features` 对象定义了路由的特殊功能和依赖：
- **requireConfig**: 指明路由是否需要特定的环境变量配置。
- **requirePuppeteer**: 指明是否需要 Puppeteer 来渲染 JavaScript。
- **antiCrawler**: 指明目标网站是否有反爬虫机制。
- **supportRadar**: 指明是否支持 RSSHub-Radar 自动发现。
- **nsfw**: 指明内容是否不适合工作场合（NSFW）。

```typescript
features: {
    requireConfig: false,
    requirePuppeteer: false,
    antiCrawler: false,
    supportRadar: true,
    nsfw: false,
}
```

### radar
`radar` 属性定义了 RSSHub-Radar 的匹配规则，允许浏览器插件自动发现并提示用户订阅。它包含 `source`（源网站 URL 模式）和 `target`（对应的 RSSHub 路由）。

```typescript
radar: [
    {
        source: ['www.dgtle.com/article'],
        target: '/article',
    },
]
```

### categories 和 view
`categories` 用于对路由进行分类，`view` 指定默认的视图类型（如文章、社交媒体、图片等）。

**Section sources**
- [types.ts](file://lib/types.ts#L320-L364)
- [dgtle/article.ts](file://lib/routes/dgtle/article.ts#L197-L206)
- [hitsz/due.ts](file://lib/routes/hitsz/due.ts#L157-L166)

## 雷达规则（Radar Rules）

雷达规则（Radar Rules）是 RSSHub 的一项重要功能，它使得 RSSHub-Radar 浏览器插件能够自动识别网页并提供订阅按钮。`radar` 属性是一个对象数组，每个对象定义了一条规则。

- **source**: 一个字符串数组，包含需要匹配的源网站 URL 模式。
- **target**: 对应的 RSSHub 订阅路径，可以是字符串或函数。

```typescript
radar: [
    {
        source: ['www.voronoiapp.com/explore'],
        target: (_, url) => {
            const parsedURL = new URL(url);
            const keyword = parsedURL.searchParams.get('search');
            return `/voronoiapp/search/${keyword}`;
        },
    },
]
```
此规则表示当用户访问 `www.voronoiapp.com/explore` 且带有 `search` 查询参数时，插件将生成对应的搜索订阅链接。

**Section sources**
- [types.ts](file://lib/types.ts#L373-L410)
- [voronoiapp/search.ts](file://lib/routes/voronoiapp/search.ts#L9-L18)

## 最佳实践与常见错误规避

### 最佳实践
1. **使用共享逻辑**：对于同一服务下的多个路由，应将公共逻辑（如数据抓取、解析）提取到 `common.ts` 文件中，避免代码重复。
2. **提供详细的 parameters**：清晰地描述每个路径参数的含义、默认值和可选项，便于用户理解和使用。
3. **合理使用缓存**：利用 RSSHub 内置的缓存中间件，减少对目标网站的请求压力。
4. **处理错误和空数据**：在处理函数中妥善处理网络错误和空数据情况，返回有意义的错误信息或空的 RSS 项。

### 常见错误规避
1. **避免硬编码 URL**：使用 `baseUrl` 常量或从配置中读取基础 URL，提高代码的可维护性。
2. **不要忽略 NSFW 标记**：如果内容可能包含不适合工作场合的信息，务必设置 `features.nsfw = true`。
3. **路径参数命名清晰**：使用有意义的参数名，避免使用模糊的缩写。
4. **测试示例 URL**：确保 `example` 属性中的 URL 是有效的，并能返回预期的数据。

**Section sources**
- [voronoiapp/common.ts](file://lib/routes/voronoiapp/common.ts)
- [dgtle/article.ts](file://lib/routes/dgtle/article.ts#L52-L166)
- [hitsz/due.ts](file://lib/routes/hitsz/due.ts#L120-L131)

## 总结

RSSHub 的路由系统设计灵活且功能强大，通过 `lib/routes/` 目录下的模块化文件、标准化的 `Route` 接口和 Hono 的路由语法，实现了对海量网站内容的高效 RSS 化。理解路由的组织结构、导出格式、路径定义、处理函数和配置项是开发和维护 RSSHub 订阅源的关键。遵循最佳实践，可以确保代码质量、用户体验和系统的稳定性。